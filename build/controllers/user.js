"use strict";

/* eslint-disable consistent-return */

/* eslint-disable no-underscore-dangle */
var express = require('express');

var router = express.Router();

var logger = require('logger').createLogger('./development.log');

var bcrypt = require('bcrypt');

var _require = require('express-validator'),
    check = _require.check,
    validationResult = _require.validationResult,
    body = _require.body;

var _require2 = require('express-validator'),
    sanitizeBody = _require2.sanitizeBody;

var _response = require('../helpers/response');

var db = require('../config/db');

var Utils = require('../helpers/utils');

var authCheck = require('../middlewares/auth_check'); // create a new user


router.post('/signup', [check('email').exists().withMessage('Email is required'), check('password').exists().withMessage('Password is required'), check('first_name').exists().withMessage('First name is required'), check('last_name').exists().withMessage('Last name is required'), body('email').not().isEmpty().escape().isEmail(), sanitizeBody('email').normalizeEmail().trim()], function (req, res) {
  var errors = validationResult(req);

  if (!errors.isEmpty()) {
    return res.status(404).json(_response.error(errors));
  }

  logger.info({
    errors: errors,
    msg: 'User auth validation'
  });
  var _req$body = req.body,
      email = _req$body.email,
      password = _req$body.password,
      first_name = _req$body.first_name,
      last_name = _req$body.last_name;
  var isAdmin = true;
  var searchQuery = "SELECT * FROM users WHERE email = '".concat(email, "' ");
  db.query(searchQuery).then(function (resp) {
    if (resp.rowCount > 0) {
      res.status(403).json(_response.error('Email already exists'));
    } else {
      // find users
      db.query('SELECT * FROM users').then(function (users) {
        if (users.rowCount > 0) {
          isAdmin = false;
        }

        bcrypt.hash(password, 10, function (err, hash) {
          if (err) {
            res.status(500).json(_response.error(err));
          } else {
            var uniqui = Utils.randomString(200);
            var query = {
              text: 'INSERT INTO users(user_id,first_name,last_name,email,password,is_admin,address) VALUES($1,$2,$3,$4,$5,$6,$7) RETURNING *',
              values: [uniqui.trimRight(), first_name, last_name, email, hash, isAdmin, 'somewhere']
            };
            db.query(query).then(function (respo) {
              var jwtdata = {
                email: respo.rows[0].email,
                userId: respo.rows[0].user_id,
                is_admin: respo.rows[0].is_admin
              };
              var token = Utils.signToken(jwtdata);
              var data = {
                user_id: respo.rows[0].user_id,
                is_admin: respo.rows[0].is_admin,
                id: respo.rows[0].user_id,
                token: token
              };
              res.status(201).json(_response.success(data));
            })["catch"](function (e) {
              logger.error(e);
              res.status(500).json(_response.error('Something went wrong'));
            });
          }
        });
        logger.info(isAdmin);
      })["catch"](function (err) {
        logger.error(err);
        res.status(505).json(_response.error('Could not fetch users'));
      }); // end find users
    }
  })["catch"](function (err) {
    res.json(_response.error(err));
  }); // res.send(response.error('Something went wrong'))
}).post('/signin', body('email').not().isEmpty().escape().isEmail(), function (req, res) {
  var errors = validationResult(req);

  if (!errors.isEmpty()) {
    return res.status(403).send(_response.error(errors));
  }

  var _req$body2 = req.body,
      email = _req$body2.email,
      password = _req$body2.password;
  var searchQuery = "SELECT * FROM users WHERE email = '".concat(email, "'");
  db.query(searchQuery).then(function (resp) {
    if (resp.rowCount <= 0) {
      res.status(403).json(_response.error('Email does not exist'));
    }

    logger.info("User ".concat(resp.rows));
    bcrypt.compare(password, resp.rows[0].password).then(function (result) {
      logger.info(result);
      var jwtdata = {
        email: resp.rows[0].email,
        userId: resp.rows[0].user_id,
        is_admin: resp.rows[0].is_admin
      };
      var token = Utils.signToken(jwtdata);
      req.headers.authorization = "Bearer ".concat(token);
      var data = {
        user_id: resp.rows[0].user_id,
        is_admin: resp.rows[0].is_admin,
        id: resp.rows[0].user_id,
        token: token
      };
      res.status(200).json(_response.success(data));
    })["catch"](function (err) {
      logger.error("Bycrypt error ".concat(err));
      res.status(500).json(_response.error('Failed to compare passwords'));
    });
  });
}).post('/admin/:userId', authCheck, function (req, res) {
  // make user an admin
  var toBeAdmin = req.params.userId;
  var data = req.decoded.data;
  var admin = data.is_admin;
  logger.info(admin);

  if (admin) {
    db.query("SELECT * FROM users WHERE user_id = '".concat(toBeAdmin, "' AND is_admin='", false, "'")).then(function (resp) {
      if (resp.rowCount > 0) {
        db.query("UPDATE users SET is_admin='".concat(true, "' WHERE user_id = '", toBeAdmin, "' RETURNING *")).then(function (newAdminData) {
          if (newAdminData.rowCount > 0) {
            res.status(200).json(_response.success(newAdminData.rows[0]));
          } else {
            res.status(500).json(_response.error('Failed to assign role'));
          }
        })["catch"](function () {
          res.status(401).json(_response.error('Opps! Something went wrong'));
        });
      } else {
        res.status(403).json(_response.error('Cannot re-assign role to user'));
      }
    })["catch"](function () {
      res.status(401).json(_response.error('Opps! Something went wrong'));
    });
  } else {
    res.status(505).json(_response.error('Your plans failed, we have a stronger algorithm'));
  }
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2FwcC9jb250cm9sbGVycy91c2VyLmpzIl0sIm5hbWVzIjpbImV4cHJlc3MiLCJyZXF1aXJlIiwicm91dGVyIiwiUm91dGVyIiwibG9nZ2VyIiwiY3JlYXRlTG9nZ2VyIiwiYmNyeXB0IiwiY2hlY2siLCJ2YWxpZGF0aW9uUmVzdWx0IiwiYm9keSIsInNhbml0aXplQm9keSIsIl9yZXNwb25zZSIsImRiIiwiVXRpbHMiLCJhdXRoQ2hlY2siLCJwb3N0IiwiZXhpc3RzIiwid2l0aE1lc3NhZ2UiLCJub3QiLCJpc0VtcHR5IiwiZXNjYXBlIiwiaXNFbWFpbCIsIm5vcm1hbGl6ZUVtYWlsIiwidHJpbSIsInJlcSIsInJlcyIsImVycm9ycyIsInN0YXR1cyIsImpzb24iLCJlcnJvciIsImluZm8iLCJtc2ciLCJlbWFpbCIsInBhc3N3b3JkIiwiZmlyc3RfbmFtZSIsImxhc3RfbmFtZSIsImlzQWRtaW4iLCJzZWFyY2hRdWVyeSIsInF1ZXJ5IiwidGhlbiIsInJlc3AiLCJyb3dDb3VudCIsInVzZXJzIiwiaGFzaCIsImVyciIsInVuaXF1aSIsInJhbmRvbVN0cmluZyIsInRleHQiLCJ2YWx1ZXMiLCJ0cmltUmlnaHQiLCJyZXNwbyIsImp3dGRhdGEiLCJyb3dzIiwidXNlcklkIiwidXNlcl9pZCIsImlzX2FkbWluIiwidG9rZW4iLCJzaWduVG9rZW4iLCJkYXRhIiwiaWQiLCJzdWNjZXNzIiwiZSIsInNlbmQiLCJjb21wYXJlIiwicmVzdWx0IiwiaGVhZGVycyIsImF1dGhvcml6YXRpb24iLCJ0b0JlQWRtaW4iLCJwYXJhbXMiLCJkZWNvZGVkIiwiYWRtaW4iLCJuZXdBZG1pbkRhdGEiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBOztBQUNBO0FBQ0EsSUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFFQSxJQUFNQyxNQUFNLEdBQUdGLE9BQU8sQ0FBQ0csTUFBUixFQUFmOztBQUNBLElBQU1DLE1BQU0s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UyxDQUFDa0IsS0FBVixDQUFnQiwrQkFBaEIsQ0FBckI7QUFDRDtBQUNGLEtBZEQsV0FjUyxZQUFNO0FBQ2JKLE1BQUFBLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCakIsU0FBUyxDQUFDa0IsS0FBVixDQUFnQiw0QkFBaEIsQ0FBckI7QUFDRCxLQWhCRDtBQWlCRCxHQWxCRCxNQWtCTztBQUNMSixJQUFBQSxHQUFHLENBQUNFLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQmpCLFNBQVMsQ0FBQ2tCLEtBQVYsQ0FBZ0IsaURBQWhCLENBQXJCO0FBQ0Q7QUFDRixDQS9JRDtBQWlKQTJDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnZFLE1BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgY29uc2lzdGVudC1yZXR1cm4gKi9cbi8qIGVzbGludC1kaXNhYmxlIG5vLXVuZGVyc2NvcmUtZGFuZ2xlICovXG5jb25zdCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xuXG5jb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnbG9nZ2VyJykuY3JlYXRlTG9nZ2VyKCcuL2RldmVsb3BtZW50LmxvZycpO1xuXG5cbmNvbnN0IGJjcnlwdCA9IHJlcXVpcmUoJ2JjcnlwdCcpO1xuY29uc3Qge1xuICBjaGVjayxcbiAgdmFsaWRhdGlvblJlc3VsdCwgYm9keSxcbn0gPSByZXF1aXJlKCdleHByZXNzLXZhbGlkYXRvcicpO1xuXG5jb25zdCB7XG4gIHNhbml0aXplQm9keSxcbn0gPSByZXF1aXJlKCdleHByZXNzLXZhbGlkYXRvcicpO1xuY29uc3QgX3Jlc3BvbnNlID0gcmVxdWlyZSgnLi4vaGVscGVycy9yZXNwb25zZScpO1xuY29uc3QgZGIgPSByZXF1aXJlKCcuLi9jb25maWcvZGInKTtcbmNvbnN0IFV0aWxzID0gcmVxdWlyZSgnLi4vaGVscGVycy91dGlscycpO1xuY29uc3QgYXV0aENoZWNrID0gcmVxdWlyZSgnLi4vbWlkZGxld2FyZXMvYXV0aF9jaGVjaycpO1xuXG4vLyBjcmVhdGUgYSBuZXcgdXNlclxucm91dGVyLnBvc3QoJy9zaWdudXAnLFxuICBbXG4gICAgY2hlY2soJ2VtYWlsJykuZXhpc3RzKCkud2l0aE1lc3NhZ2UoJ0VtYWlsIGlzIHJlcXVpcmVkJyksXG4gICAgY2hlY2soJ3Bhc3N3b3JkJykuZXhpc3RzKCkud2l0aE1lc3NhZ2UoJ1Bhc3N3b3JkIGlzIHJlcXVpcmVkJyksXG4gICAgY2hlY2soJ2ZpcnN0X25hbWUnKS5leGlzdHMoKS53aXRoTWVzc2FnZSgnRmlyc3QgbmFtZSBpcyByZXF1aXJlZCcpLFxuICAgIGNoZWNrKCdsYXN0X25hbWUnKS5leGlzdHMoKS53aXRoTWVzc2FnZSgnTGFzdCBuYW1lIGlzIHJlcXVpcmVkJyksXG4gICAgYm9keSgnZW1haWwnKS5ub3QoKS5pc0VtcHR5KCkuZXNjYXBlKClcbiAgICAgIC5pc0VtYWlsKCksXG4gICAgc2FuaXRpemVCb2R5KCdlbWFpbCcpLm5vcm1hbGl6ZUVtYWlsKCkudHJpbSgpLFxuICBdLCAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0aW9uUmVzdWx0KHJlcSk7XG4gICAgaWYgKCFlcnJvcnMuaXNFbXB0eSgpKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oX3Jlc3BvbnNlLmVycm9yKGVycm9ycykpO1xuICAgIH1cbiAgICBsb2dnZXIuaW5mbyh7IGVycm9ycywgbXNnOiAnVXNlciBhdXRoIHZhbGlkYXRpb24nIH0pO1xuICAgIGNvbnN0IHtcbiAgICAgIGVtYWlsLFxuICAgICAgcGFzc3dvcmQsXG4gICAgICBmaXJzdF9uYW1lLFxuICAgICAgbGFzdF9uYW1lLFxuICAgIH0gPSByZXEuYm9keTtcbiAgICBsZXQgaXNBZG1pbiA9IHRydWU7XG4gICAgY29uc3Qgc2VhcmNoUXVlcnkgPSBgU0VMRUNUICogRlJPTSB1c2VycyBXSEVSRSBlbWFpbCA9ICcke2VtYWlsfScgYDtcblxuICAgIGRiLnF1ZXJ5KHNlYXJjaFF1ZXJ5KS50aGVuKChyZXNwKSA9PiB7XG4gICAgICBpZiAocmVzcC5yb3dDb3VudCA+IDApIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDMpLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdFbWFpbCBhbHJlYWR5IGV4aXN0cycpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGZpbmQgdXNlcnNcbiAgICAgICAgZGIucXVlcnkoJ1NFTEVDVCAqIEZST00gdXNlcnMnKS50aGVuKCh1c2VycykgPT4ge1xuICAgICAgICAgIGlmICh1c2Vycy5yb3dDb3VudCA+IDApIHtcbiAgICAgICAgICAgIGlzQWRtaW4gPSBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYmNyeXB0Lmhhc2gocGFzc3dvcmQsIDEwLCAoZXJyLCBoYXNoKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKF9yZXNwb25zZS5lcnJvcihlcnIpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnN0IHVuaXF1aSA9IFV0aWxzLnJhbmRvbVN0cmluZygyMDApO1xuICAgICAgICAgICAgICBjb25zdCBxdWVyeSA9IHtcbiAgICAgICAgICAgICAgICB0ZXh0OiAnSU5TRVJUIElOVE8gdXNlcnModXNlcl9pZCxmaXJzdF9uYW1lLGxhc3RfbmFtZSxlbWFpbCxwYXNzd29yZCxpc19hZG1pbixhZGRyZXNzKSBWQUxVRVMoJDEsJDIsJDMsJDQsJDUsJDYsJDcpIFJFVFVSTklORyAqJyxcbiAgICAgICAgICAgICAgICB2YWx1ZXM6IFt1bmlxdWkudHJpbVJpZ2h0KCksIGZpcnN0X25hbWUsIGxhc3RfbmFtZSwgZW1haWwsIGhhc2gsIGlzQWRtaW4sICdzb21ld2hlcmUnXSxcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgZGIucXVlcnkocXVlcnkpXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvKSA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBqd3RkYXRhID0ge1xuICAgICAgICAgICAgICAgICAgICBlbWFpbDogcmVzcG8ucm93c1swXS5lbWFpbCxcbiAgICAgICAgICAgICAgICAgICAgdXNlcklkOiByZXNwby5yb3dzWzBdLnVzZXJfaWQsXG4gICAgICAgICAgICAgICAgICAgIGlzX2FkbWluOiByZXNwby5yb3dzWzBdLmlzX2FkbWluLFxuICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHRva2VuID0gVXRpbHMuc2lnblRva2VuKGp3dGRhdGEpO1xuICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgdXNlcl9pZDogcmVzcG8ucm93c1swXS51c2VyX2lkLFxuICAgICAgICAgICAgICAgICAgICBpc19hZG1pbjogcmVzcG8ucm93c1swXS5pc19hZG1pbixcbiAgICAgICAgICAgICAgICAgICAgaWQ6IHJlc3BvLnJvd3NbMF0udXNlcl9pZCxcbiAgICAgICAgICAgICAgICAgICAgdG9rZW4sXG4gICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24oX3Jlc3BvbnNlLnN1Y2Nlc3MoZGF0YSkpO1xuICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICAgICAgICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbihfcmVzcG9uc2UuZXJyb3IoJ1NvbWV0aGluZyB3ZW50IHdyb25nJykpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGxvZ2dlci5pbmZvKGlzQWRtaW4pO1xuICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKGVycik7XG4gICAgICAgICAgcmVzLnN0YXR1cyg1MDUpLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdDb3VsZCBub3QgZmV0Y2ggdXNlcnMnKSk7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBlbmQgZmluZCB1c2Vyc1xuICAgICAgfVxuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIHJlcy5qc29uKF9yZXNwb25zZS5lcnJvcihlcnIpKTtcbiAgICB9KTtcblxuXG4gICAgLy8gcmVzLnNlbmQocmVzcG9uc2UuZXJyb3IoJ1NvbWV0aGluZyB3ZW50IHdyb25nJykpXG4gIH0pLnBvc3QoJy9zaWduaW4nLCBib2R5KCdlbWFpbCcpLm5vdCgpLmlzRW1wdHkoKS5lc2NhcGUoKVxuICAuaXNFbWFpbCgpLFxuKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IGVycm9ycyA9IHZhbGlkYXRpb25SZXN1bHQocmVxKTtcbiAgaWYgKCFlcnJvcnMuaXNFbXB0eSgpKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5zZW5kKF9yZXNwb25zZS5lcnJvcihlcnJvcnMpKTtcbiAgfVxuICBjb25zdCB7XG4gICAgZW1haWwsXG4gICAgcGFzc3dvcmQsXG4gIH0gPSByZXEuYm9keTtcbiAgY29uc3Qgc2VhcmNoUXVlcnkgPSBgU0VMRUNUICogRlJPTSB1c2VycyBXSEVSRSBlbWFpbCA9ICcke2VtYWlsfSdgO1xuXG4gIGRiLnF1ZXJ5KHNlYXJjaFF1ZXJ5KS50aGVuKChyZXNwKSA9PiB7XG4gICAgaWYgKHJlc3Aucm93Q291bnQgPD0gMCkge1xuICAgICAgcmVzLnN0YXR1cyg0MDMpLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdFbWFpbCBkb2VzIG5vdCBleGlzdCcpKTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oYFVzZXIgJHtyZXNwLnJvd3N9YCk7XG4gICAgYmNyeXB0LmNvbXBhcmUocGFzc3dvcmQsIHJlc3Aucm93c1swXS5wYXNzd29yZCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICBsb2dnZXIuaW5mbyhyZXN1bHQpO1xuICAgICAgY29uc3Qgand0ZGF0YSA9IHtcbiAgICAgICAgZW1haWw6IHJlc3Aucm93c1swXS5lbWFpbCxcbiAgICAgICAgdXNlcklkOiByZXNwLnJvd3NbMF0udXNlcl9pZCxcbiAgICAgICAgaXNfYWRtaW46IHJlc3Aucm93c1swXS5pc19hZG1pbixcbiAgICAgIH07XG4gICAgICBjb25zdCB0b2tlbiA9IFV0aWxzLnNpZ25Ub2tlbihqd3RkYXRhKTtcbiAgICAgIHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7dG9rZW59YDtcbiAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgIHVzZXJfaWQ6IHJlc3Aucm93c1swXS51c2VyX2lkLFxuICAgICAgICBpc19hZG1pbjogcmVzcC5yb3dzWzBdLmlzX2FkbWluLFxuICAgICAgICBpZDogcmVzcC5yb3dzWzBdLnVzZXJfaWQsXG4gICAgICAgIHRva2VuLFxuICAgICAgfTtcbiAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKF9yZXNwb25zZS5zdWNjZXNzKGRhdGEpKTtcbiAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoYEJ5Y3J5cHQgZXJyb3IgJHtlcnJ9YCk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbihfcmVzcG9uc2UuZXJyb3IoJ0ZhaWxlZCB0byBjb21wYXJlIHBhc3N3b3JkcycpKTtcbiAgICB9KTtcbiAgfSk7XG59KS5wb3N0KCcvYWRtaW4vOnVzZXJJZCcsIGF1dGhDaGVjaywgKHJlcSwgcmVzKSA9PiB7XG4gIC8vIG1ha2UgdXNlciBhbiBhZG1pblxuICBjb25zdCB0b0JlQWRtaW4gPSByZXEucGFyYW1zLnVzZXJJZDtcbiAgY29uc3QgeyBkYXRhIH0gPSByZXEuZGVjb2RlZDtcbiAgY29uc3QgYWRtaW4gPSBkYXRhLmlzX2FkbWluO1xuXG4gIGxvZ2dlci5pbmZvKGFkbWluKTtcbiAgaWYgKGFkbWluKSB7XG4gICAgZGIucXVlcnkoYFNFTEVDVCAqIEZST00gdXNlcnMgV0hFUkUgdXNlcl9pZCA9ICcke3RvQmVBZG1pbn0nIEFORCBpc19hZG1pbj0nJHtmYWxzZX0nYCkudGhlbigocmVzcCkgPT4ge1xuICAgICAgaWYgKHJlc3Aucm93Q291bnQgPiAwKSB7XG4gICAgICAgIGRiLnF1ZXJ5KGBVUERBVEUgdXNlcnMgU0VUIGlzX2FkbWluPScke3RydWV9JyBXSEVSRSB1c2VyX2lkID0gJyR7dG9CZUFkbWlufScgUkVUVVJOSU5HICpgKS50aGVuKChuZXdBZG1pbkRhdGEpID0+IHtcbiAgICAgICAgICBpZiAobmV3QWRtaW5EYXRhLnJvd0NvdW50ID4gMCkge1xuICAgICAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oX3Jlc3BvbnNlLnN1Y2Nlc3MobmV3QWRtaW5EYXRhLnJvd3NbMF0pKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdGYWlsZWQgdG8gYXNzaWduIHJvbGUnKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KS5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdPcHBzISBTb21ldGhpbmcgd2VudCB3cm9uZycpKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc3RhdHVzKDQwMykuanNvbihfcmVzcG9uc2UuZXJyb3IoJ0Nhbm5vdCByZS1hc3NpZ24gcm9sZSB0byB1c2VyJykpO1xuICAgICAgfVxuICAgIH0pLmNhdGNoKCgpID0+IHtcbiAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKF9yZXNwb25zZS5lcnJvcignT3BwcyEgU29tZXRoaW5nIHdlbnQgd3JvbmcnKSk7XG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgcmVzLnN0YXR1cyg1MDUpLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdZb3VyIHBsYW5zIGZhaWxlZCwgd2UgaGF2ZSBhIHN0cm9uZ2VyIGFsZ29yaXRobScpKTtcbiAgfVxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gcm91dGVyO1xuIl19