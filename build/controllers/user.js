"use strict";

/* eslint-disable consistent-return */

/* eslint-disable no-underscore-dangle */
var express = require('express');

var router = express.Router();

var logger = require('logger').createLogger('./development.log');

var bcrypt = require('bcrypt');

var _require = require('express-validator'),
    check = _require.check,
    validationResult = _require.validationResult,
    body = _require.body;

var _require2 = require('express-validator'),
    sanitizeBody = _require2.sanitizeBody;

var _response = require('../helpers/response');

var db = require('../config/db');

var Utils = require('../helpers/utils');

var authCheck = require('../middlewares/auth_check'); // create a new user


router.post('/signup', [check('email').exists().withMessage('Email is required'), check('password').exists().withMessage('Password is required'), check('first_name').exists().withMessage('First name is required'), check('last_name').exists().withMessage('Last name is required'), body('email').not().isEmpty().escape().isEmail(), sanitizeBody('email').normalizeEmail().trim()], function (req, res) {
  var errors = validationResult(req);

  if (!errors.isEmpty()) {
    return res.status(404).json(_response.error(errors));
  }

  logger.info({
    errors: errors,
    msg: 'User auth validation'
  });
  var _req$body = req.body,
      email = _req$body.email,
      password = _req$body.password,
      first_name = _req$body.first_name,
      last_name = _req$body.last_name;
  var isAdmin = true;
  var searchQuery = "SELECT * FROM users WHERE email = '".concat(email, "' ");
  db.query(searchQuery).then(function (resp) {
    if (resp.rowCount > 0) {
      res.status(403).json(_response.error('Email already exists'));
    } else {
      // find users
      db.query('SELECT * FROM users').then(function (users) {
        if (users.rowCount > 0) {
          isAdmin = false;
        }

        bcrypt.hash(password, 10, function (err, hash) {
          if (err) {
            res.status(500).json(_response.error(err));
          } else {
            var uniqui = Utils.randomString(200);
            var query = {
              text: 'INSERT INTO users(user_id,first_name,last_name,email,password,is_admin,address) VALUES($1,$2,$3,$4,$5,$6,$7) RETURNING *',
              values: [uniqui.trimRight(), first_name, last_name, email, hash, isAdmin, 'somewhere']
            };
            db.query(query).then(function (respo) {
              var jwtdata = {
                email: respo.rows[0].email,
                userId: respo.rows[0].user_id,
                is_admin: respo.rows[0].is_admin
              };
              var token = Utils.signToken(jwtdata);
              var data = {
                user_id: respo.rows[0].user_id,
                is_admin: respo.rows[0].is_admin,
                token: token
              };
              res.status(201).json(_response.success(data));
            })["catch"](function (e) {
              logger.error(e);
              res.status(500).json(_response.error('Something went wrong'));
            });
          }
        });
        logger.info(isAdmin);
      })["catch"](function (err) {
        logger.error(err);
        res.status(505).json(_response.error('Could not fetch users'));
      }); // end find users
    }
  })["catch"](function (err) {
    res.json(_response.error(err));
  }); // res.send(response.error('Something went wrong'))
}).post('/signin', body('email').not().isEmpty().escape().isEmail(), function (req, res) {
  var errors = validationResult(req);

  if (!errors.isEmpty()) {
    return res.status(403).send(_response.error(errors));
  }

  var _req$body2 = req.body,
      email = _req$body2.email,
      password = _req$body2.password;
  var searchQuery = "SELECT * FROM users WHERE email = '".concat(email, "' LIMIT 1");
  db.query(searchQuery).then(function (resp) {
    if (resp.rowCount <= 0) {
      res.status(403).json(_response.error('Email does not exist'));
    }

    bcrypt.compare(password, resp.rows[0].password, function (err, result) {
      // res == true
      if (err) {
        res.status(401).json(_response.error('Failed with code x(2e2x)'));
      }

      if (result) {
        var jwtdata = {
          email: resp.rows[0].email,
          userId: resp.rows[0].user_id,
          is_admin: resp.rows[0].is_admin
        };
        var token = Utils.signToken(jwtdata);
        req.headers.authorization = "Bearer ".concat(token);
        var data = {
          user_id: resp.rows[0].user_id,
          is_admin: resp.rows[0].is_admin,
          token: token
        };
        res.status(200).json(_response.success(data));
      }
    });
  });
}).post('/admin/:userId', authCheck, function (req, res) {
  // make user an admin
  var toBeAdmin = req.params.userId;
  var data = req.decoded.data;
  var admin = data.is_admin;
  logger.info(admin);

  if (admin) {
    db.query("SELECT * FROM users WHERE user_id = '".concat(toBeAdmin, "' AND is_admin='", false, "'")).then(function (resp) {
      if (resp.rowCount > 0) {
        db.query("UPDATE users SET is_admin='".concat(true, "' WHERE user_id = '", toBeAdmin, "' RETURNING *")).then(function (newAdminData) {
          if (newAdminData.rowCount > 0) {
            res.status(200).json(_response.success(newAdminData.rows[0]));
          } else {
            res.status(500).json(_response.error('Failed to assign role'));
          }
        })["catch"](function () {
          res.status(401).json(_response.error('Opps! Something went wrong'));
        });
      } else {
        res.status(403).json(_response.error('Cannot re-assign role to user'));
      }
    })["catch"](function () {
      res.status(401).json(_response.error('Opps! Something went wrong'));
    });
  } else {
    res.status(505).json(_response.error('Your plans failed, we have a stronger algorithm'));
  }
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2FwcC9jb250cm9sbGVycy91c2VyLmpzIl0sIm5hbWVzIjpbImV4cHJlc3MiLCJyZXF1aXJlIiwicm91dGVyIiwiUm91dGVyIiwibG9nZ2VyIiwiY3JlYXRlTG9nZ2VyIiwiYmNyeXB0IiwiY2hlY2siLCJ2YWxpZGF0aW9uUmVzdWx0IiwiYm9keSIsInNhbml0aXplQm9keSIsIl9yZXNwb25zZSIsImRiIiwiVXRpbHMiLCJhdXRoQ2hlY2siLCJwb3N0IiwiZXhpc3RzIiwid2l0aE1lc3NhZ2UiLCJub3QiLCJpc0VtcHR5IiwiZXNjYXBlIiwiaXNFbWFpbCIsIm5vcm1hbGl6ZUVtYWlsIiwidHJpbSIsInJlcSIsInJlcyIsImVycm9ycyIsInN0YXR1cyIsImpzb24iLCJlcnJvciIsImluZm8iLCJtc2ciLCJlbWFpbCIsInBhc3N3b3JkIiwiZmlyc3RfbmFtZSIsImxhc3RfbmFtZSIsImlzQWRtaW4iLCJzZWFyY2hRdWVyeSIsInF1ZXJ5IiwidGhlbiIsInJlc3AiLCJyb3dDb3VudCIsInVzZXJzIiwiaGFzaCIsImVyciIsInVuaXF1aSIsInJhbmRvbVN0cmluZyIsInRleHQiLCJ2YWx1ZXMiLCJ0cmltUmlnaHQiLCJyZXNwbyIsImp3dGRhdGEiLCJyb3dzIiwidXNlcklkIiwidXNlcl9pZCIsImlzX2FkbWluIiwidG9rZW4iLCJzaWduVG9rZW4iLCJkYXRhIiwic3VjY2VzcyIsImUiLCJzZW5kIiwiY29tcGFyZSIsInJlc3VsdCIsImhlYWRlcnMiLCJhdXRob3JpemF0aW9uIiwidG9CZUFkbWluIiwicGFyYW1zIiwiZGVjb2RlZCIsImFkbWluIiwibmV3QWRtaW5EYXRhIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7QUFDQTtBQUNBLElBQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLFNBQUQsQ0FBdkI7O0FBRUEsSUFBTUMsTUFBTSxHQUFHRixPQUFPLENBQUNHLE1BQVIsRUFBZjs7QUFDQSxJQUFNQyxNQUFNLEdBQUdILE9BQU8sQ0FBQyxRQUFELENBQVAsQ0FBa0JJLFlBQWxCLENBQStCLG1CQUEvQixDQUFmOztBQUdBLElBQU1DLE1BQU0sR0FBR0wsT0FBTyxDQUFDLFFBQUQsQ0FBdEI7O2VBSUlBLE9BQU8sQ0FBQyxtQkFBRCxDO0lBRlRNLEssWUFBQUEsSztJQUNBQyxnQixZQUFBQSxnQjtJQUFrQkMsSSxZQUFBQSxJOztnQkFLaEJSLE9BQU8sQ0FBQyxtQkFBRCxDO0lBRFRTLFksYUFBQUEsWTs7QUFFRixJQUFNQyxTQUFTLEdBQUdWLE9BQU8sQ0FBQyxxQkFBRCxDQUF6Qjs7QUFDQSxJQUFNVyxFQUFFLEdBQUdYLE9BQU8sQ0FBQyxjQUFELENBQWxCOztBQUNBLElBQU1ZLEtBQUssR0FBR1osT0FBTyxDQUFDLGtCQUFELENBQXJCOztBQUNBLElBQU1hLFNBQVMsR0FBR2IsT0FBTyxDQUFDLDJCQUFELENBQXpCLEMsQ0FFQTs7O0FBQ0FDLE1BQU0sQ0FBQ2EsSUFBUCxDQUFZLFNBQVosRUFDRSxDQUNFUixLQUFLLENBQUMsT0FBRCxDQUFMLENBQWVTLE1BQWYsR0FBd0JDLFdBQXhCLENBQW9DLG1CQUFwQyxDQURGLEVBRUVWLEtBQUssQ0FBQyxVQUFELENBQUwsQ0FBa0JTLE1BQWxCLEdBQTJCQyxXQUEzQixDQUF1QyxzQkFBdkMsQ0FGRixFQUdFVixLQUFLLENBQUMsWUFBRCxDQUFMLENBQW9CUyxNQUFwQixHQUE2QkMsV0FBN0IsQ0FBeUMsd0JBQXpDLENBSEYsRUFJRVYsS0FBSyxDQUFDLFdBQUQsQ0FBTCxDQUFtQlMsTUFBbkIsR0FBNEJDLFdBQTVCLENBQXdDLHVCQUF4QyxDQUpGLEVBS0VSLElBQUksQ0FBQyxPQUFELENBQUosQ0FBY1MsR0FBZCxHQUFvQkMsT0FBcEIsR0FBOEJDLE1BQTlCLEdBQ0dDLE9BREgsRUFMRixFQU9FWCxZQUFZLENBQUMsT0FBRCxDQUFaLENBQXNCWSxjQUF0QixHQUF1Q0MsSUFBdkMsRUFQRixDQURGLEVBU0ssVUFBQ0MsR0FBRCxFQUFNQyxHQUFOLEVBQWM7QUFDZixNQUFNQyxNQUFNLEdBQUdsQixnQkFBZ0IsQ0FBQ2dCLEdBQUQsQ0FBL0I7O0FBQ0EsTUFBSSxDQUFDRSxNQUFNLENBQUNQLE9BQVAsRUFBTCxFQUF1QjtBQUNyQixXQUFPTSxHQUFHLENBQUNFLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQmpCLFNBQVMsQ0FBQ2tCLEtBQVYsQ0FBZ0JILE1BQWhCLENBQXJCLENBQVA7QUFDRDs7QUFDRHRCLEVBQUFBLE1BQU0sQ0FBQzBCLElBQVAsQ0FBWTtBQUFFSixJQUFBQSxNQUFNLEVBQU5BLE1BQUY7QUFBVUssSUFBQUEsR0FBRyxFQUFFO0FBQWYsR0FBWjtBQUxlLGtCQVdYUCxHQUFHLENBQUNmLElBWE87QUFBQSxNQU9idUIsS0FQYSxhQU9iQSxLQVBhO0FBQUEsTUFRYkMsUUFSYSxhQVFiQSxRQVJhO0FBQUEsTUFTYkMsVUFUYSxhQVNiQSxVQVRhO0FBQUEsTUFVYkMsU0FWYSxhQVViQSxTQVZhO0FBWWYsTUFBSUMsT0FBTyxHQUFHLElBQWQ7QUFDQSxNQUFNQyxXQUFXLGdEQUF5Q0wsS0FBekMsT0FBakI7QUFFQXBCLEVBQUFBLEVBQUUsQ0FBQzBCLEtBQUgsQ0FBU0QsV0FBVCxFQUFzQkUsSUFBdEIsQ0FBMkIsVUFBQ0MsSUFBRCxFQUFVO0FBQ25DLFFBQUlBLElBQUksQ0FBQ0MsUUFBTCxHQUFnQixDQUFwQixFQUF1QjtBQUNyQmhCLE1BQUFBLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCakIsU0FBUyxDQUFDa0IsS0FBVixDQUFnQixzQkFBaEIsQ0FBckI7QUFDRCxLQUZELE1BRU87QUFDTDtBQUNBakIsTUFBQUEsRUFBRSxDQUFDMEIsS0FBSCxDQUFTLHFCQUFULEVBQWdDQyxJQUFoQyxDQUFxQyxVQUFDRyxLQUFELEVBQVc7QUFDOUMsWUFBSUEsS0FBSyxDQUFDRCxRQUFOLEdBQWlCLENBQXJCLEVBQXdCO0FBQ3RCTCxVQUFBQSxPQUFPLEdBQUcsS0FBVjtBQUNEOztBQUNEOUIsUUFBQUEsTUFBTSxDQUFDcUMsSUFBUCxDQUFZVixRQUFaLEVBQXNCLEVBQXRCLEVBQTBCLFVBQUNXLEdBQUQsRUFBTUQsSUFBTixFQUFlO0FBQ3ZDLGNBQUlDLEdBQUosRUFBUztBQUNQbkIsWUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJqQixTQUFTLENBQUNrQixLQUFWLENBQWdCZSxHQUFoQixDQUFyQjtBQUNELFdBRkQsTUFFTztBQUNMLGdCQUFNQyxNQUFNLEdBQUdoQyxLQUFLLENBQUNpQyxZQUFOLENBQW1CLEdBQW5CLENBQWY7QUFDQSxnQkFBTVIsS0FBSyxHQUFHO0FBQ1pTLGNBQUFBLElBQUksRUFBRSwwSEFETTtBQUVaQyxjQUFBQSxNQUFNLEVBQUUsQ0FBQ0gsTUFBTSxDQUFDSSxTQUFQLEVBQUQsRUFBcUJmLFVBQXJCLEVBQWlDQyxTQUFqQyxFQUE0Q0gsS0FBNUMsRUFBbURXLElBQW5ELEVBQXlEUCxPQUF6RCxFQUFrRSxXQUFsRTtBQUZJLGFBQWQ7QUFJQXhCLFlBQUFBLEVBQUUsQ0FBQzBCLEtBQUgsQ0FBU0EsS0FBVCxFQUNHQyxJQURILENBQ1EsVUFBQ1csS0FBRCxFQUFXO0FBQ2Ysa0JBQU1DLE9BQU8sR0FBRztBQUNkbkIsZ0JBQUFBLEtBQUssRUFBRWtCLEtBQUssQ0FBQ0UsSUFBTixDQUFXLENBQVgsRUFBY3BCLEtBRFA7QUFFZHFCLGdCQUFBQSxNQUFNLEVBQUVILEtBQUssQ0FBQ0UsSUFBTixDQUFXLENBQVgsRUFBY0UsT0FGUjtBQUdkQyxnQkFBQUEsUUFBUSxFQUFFTCxLQUFLLENBQUNFLElBQU4sQ0FBVyxDQUFYLEVBQWNHO0FBSFYsZUFBaEI7QUFLQSxrQkFBTUMsS0FBSyxHQUFHM0MsS0FBSyxDQUFDNEMsU0FBTixDQUFnQk4sT0FBaEIsQ0FBZDtBQUNBLGtCQUFNTyxJQUFJLEdBQUc7QUFDWEosZ0JBQUFBLE9BQU8sRUFBRUosS0FBSyxDQUFDRSxJQUFOLENBQVcsQ0FBWCxFQUFjRSxPQURaO0FBRVhDLGdCQUFBQSxRQUFRLEVBQUVMLEtBQUssQ0FBQ0UsSUFBTixDQUFXLENBQVgsRUFBY0csUUFGYjtBQUdYQyxnQkFBQUEsS0FBSyxFQUFMQTtBQUhXLGVBQWI7QUFLQS9CLGNBQUFBLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCakIsU0FBUyxDQUFDZ0QsT0FBVixDQUFrQkQsSUFBbEIsQ0FBckI7QUFDRCxhQWRILFdBY1csVUFBQ0UsQ0FBRCxFQUFPO0FBQ2R4RCxjQUFBQSxNQUFNLENBQUN5QixLQUFQLENBQWErQixDQUFiO0FBQ0FuQyxjQUFBQSxHQUFHLENBQUNFLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQmpCLFNBQVMsQ0FBQ2tCLEtBQVYsQ0FBZ0Isc0JBQWhCLENBQXJCO0FBQ0QsYUFqQkg7QUFrQkQ7QUFDRixTQTVCRDtBQTZCQXpCLFFBQUFBLE1BQU0sQ0FBQzBCLElBQVAsQ0FBWU0sT0FBWjtBQUNELE9BbENELFdBa0NTLFVBQUNRLEdBQUQsRUFBUztBQUNoQnhDLFFBQUFBLE1BQU0sQ0FBQ3lCLEtBQVAsQ0FBYWUsR0FBYjtBQUNBbkIsUUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJqQixTQUFTLENBQUNrQixLQUFWLENBQWdCLHVCQUFoQixDQUFyQjtBQUNELE9BckNELEVBRkssQ0F3Q0w7QUFDRDtBQUNGLEdBN0NELFdBNkNTLFVBQUNlLEdBQUQsRUFBUztBQUNoQm5CLElBQUFBLEdBQUcsQ0FBQ0csSUFBSixDQUFTakIsU0FBUyxDQUFDa0IsS0FBVixDQUFnQmUsR0FBaEIsQ0FBVDtBQUNELEdBL0NELEVBZmUsQ0FpRWY7QUFDRCxDQTNFSCxFQTJFSzdCLElBM0VMLENBMkVVLFNBM0VWLEVBMkVxQk4sSUFBSSxDQUFDLE9BQUQsQ0FBSixDQUFjUyxHQUFkLEdBQW9CQyxPQUFwQixHQUE4QkMsTUFBOUIsR0FDbEJDLE9BRGtCLEVBM0VyQixFQTZFQSxVQUFDRyxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUNaLE1BQU1DLE1BQU0sR0FBR2xCLGdCQUFnQixDQUFDZ0IsR0FBRCxDQUEvQjs7QUFDQSxNQUFJLENBQUNFLE1BQU0sQ0FBQ1AsT0FBUCxFQUFMLEVBQXVCO0FBQ3JCLFdBQU9NLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JrQyxJQUFoQixDQUFxQmxELFNBQVMsQ0FBQ2tCLEtBQVYsQ0FBZ0JILE1BQWhCLENBQXJCLENBQVA7QUFDRDs7QUFKVyxtQkFRUkYsR0FBRyxDQUFDZixJQVJJO0FBQUEsTUFNVnVCLEtBTlUsY0FNVkEsS0FOVTtBQUFBLE1BT1ZDLFFBUFUsY0FPVkEsUUFQVTtBQVNaLE1BQU1JLFdBQVcsZ0RBQXlDTCxLQUF6QyxjQUFqQjtBQUVBcEIsRUFBQUEsRUFBRSxDQUFDMEIsS0FBSCxDQUFTRCxXQUFULEVBQXNCRSxJQUF0QixDQUEyQixVQUFDQyxJQUFELEVBQVU7QUFDbkMsUUFBSUEsSUFBSSxDQUFDQyxRQUFMLElBQWlCLENBQXJCLEVBQXdCO0FBQ3RCaEIsTUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJqQixTQUFTLENBQUNrQixLQUFWLENBQWdCLHNCQUFoQixDQUFyQjtBQUNEOztBQUVEdkIsSUFBQUEsTUFBTSxDQUFDd0QsT0FBUCxDQUFlN0IsUUFBZixFQUF5Qk8sSUFBSSxDQUFDWSxJQUFMLENBQVUsQ0FBVixFQUFhbkIsUUFBdEMsRUFBZ0QsVUFBQ1csR0FBRCxFQUFNbUIsTUFBTixFQUFpQjtBQUMvRDtBQUNBLFVBQUluQixHQUFKLEVBQVM7QUFDUG5CLFFBQUFBLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCakIsU0FBUyxDQUFDa0IsS0FBVixDQUFnQiwwQkFBaEIsQ0FBckI7QUFDRDs7QUFDRCxVQUFJa0MsTUFBSixFQUFZO0FBQ1YsWUFBTVosT0FBTyxHQUFHO0FBQ2RuQixVQUFBQSxLQUFLLEVBQUVRLElBQUksQ0FBQ1ksSUFBTCxDQUFVLENBQVYsRUFBYXBCLEtBRE47QUFFZHFCLFVBQUFBLE1BQU0sRUFBRWIsSUFBSSxDQUFDWSxJQUFMLENBQVUsQ0FBVixFQUFhRSxPQUZQO0FBR2RDLFVBQUFBLFFBQVEsRUFBRWYsSUFBSSxDQUFDWSxJQUFMLENBQVUsQ0FBVixFQUFhRztBQUhULFNBQWhCO0FBS0EsWUFBTUMsS0FBSyxHQUFHM0MsS0FBSyxDQUFDNEMsU0FBTixDQUFnQk4sT0FBaEIsQ0FBZDtBQUNBM0IsUUFBQUEsR0FBRyxDQUFDd0MsT0FBSixDQUFZQyxhQUFaLG9CQUFzQ1QsS0FBdEM7QUFDQSxZQUFNRSxJQUFJLEdBQUc7QUFDWEosVUFBQUEsT0FBTyxFQUFFZCxJQUFJLENBQUNZLElBQUwsQ0FBVSxDQUFWLEVBQWFFLE9BRFg7QUFFWEMsVUFBQUEsUUFBUSxFQUFFZixJQUFJLENBQUNZLElBQUwsQ0FBVSxDQUFWLEVBQWFHLFFBRlo7QUFHWEMsVUFBQUEsS0FBSyxFQUFMQTtBQUhXLFNBQWI7QUFLQS9CLFFBQUFBLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCakIsU0FBUyxDQUFDZ0QsT0FBVixDQUFrQkQsSUFBbEIsQ0FBckI7QUFDRDtBQUNGLEtBcEJEO0FBcUJELEdBMUJEO0FBMkJELENBbkhELEVBbUhHM0MsSUFuSEgsQ0FtSFEsZ0JBbkhSLEVBbUgwQkQsU0FuSDFCLEVBbUhxQyxVQUFDVSxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUNqRDtBQUNBLE1BQU15QyxTQUFTLEdBQUcxQyxHQUFHLENBQUMyQyxNQUFKLENBQVdkLE1BQTdCO0FBRmlELE1BR3pDSyxJQUh5QyxHQUdoQ2xDLEdBQUcsQ0FBQzRDLE9BSDRCLENBR3pDVixJQUh5QztBQUlqRCxNQUFNVyxLQUFLLEdBQUdYLElBQUksQ0FBQ0gsUUFBbkI7QUFFQW5ELEVBQUFBLE1BQU0sQ0FBQzBCLElBQVAsQ0FBWXVDLEtBQVo7O0FBQ0EsTUFBSUEsS0FBSixFQUFXO0FBQ1R6RCxJQUFBQSxFQUFFLENBQUMwQixLQUFILGdEQUFpRDRCLFNBQWpELHNCQUE2RSxLQUE3RSxRQUF1RjNCLElBQXZGLENBQTRGLFVBQUNDLElBQUQsRUFBVTtBQUNwRyxVQUFJQSxJQUFJLENBQUNDLFFBQUwsR0FBZ0IsQ0FBcEIsRUFBdUI7QUFDckI3QixRQUFBQSxFQUFFLENBQUMwQixLQUFILHNDQUF1QyxJQUF2Qyx5QkFBaUU0QixTQUFqRSxvQkFBMkYzQixJQUEzRixDQUFnRyxVQUFDK0IsWUFBRCxFQUFrQjtBQUNoSCxjQUFJQSxZQUFZLENBQUM3QixRQUFiLEdBQXdCLENBQTVCLEVBQStCO0FBQzdCaEIsWUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJqQixTQUFTLENBQUNnRCxPQUFWLENBQWtCVyxZQUFZLENBQUNsQixJQUFiLENBQWtCLENBQWxCLENBQWxCLENBQXJCO0FBQ0QsV0FGRCxNQUVPO0FBQ0wzQixZQUFBQSxHQUFHLENBQUNFLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQmpCLFNBQVMsQ0FBQ2tCLEtBQVYsQ0FBZ0IsdUJBQWhCLENBQXJCO0FBQ0Q7QUFDRixTQU5ELFdBTVMsWUFBTTtBQUNiSixVQUFBQSxHQUFHLENBQUNFLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQmpCLFNBQVMsQ0FBQ2tCLEtBQVYsQ0FBZ0IsNEJBQWhCLENBQXJCO0FBQ0QsU0FSRDtBQVNELE9BVkQsTUFVTztBQUNMSixRQUFBQSxHQUFHLENBQUNFLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQmpCLFNBQVMsQ0FBQ2tCLEtBQVYsQ0FBZ0IsK0JBQWhCLENBQXJCO0FBQ0Q7QUFDRixLQWRELFdBY1MsWUFBTTtBQUNiSixNQUFBQSxHQUFHLENBQUNFLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQmpCLFNBQVMsQ0FBQ2tCLEtBQVYsQ0FBZ0IsNEJBQWhCLENBQXJCO0FBQ0QsS0FoQkQ7QUFpQkQsR0FsQkQsTUFrQk87QUFDTEosSUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJqQixTQUFTLENBQUNrQixLQUFWLENBQWdCLGlEQUFoQixDQUFyQjtBQUNEO0FBQ0YsQ0EvSUQ7QUFpSkEwQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ0RSxNQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIGNvbnNpc3RlbnQtcmV0dXJuICovXG4vKiBlc2xpbnQtZGlzYWJsZSBuby11bmRlcnNjb3JlLWRhbmdsZSAqL1xuY29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcblxuY29uc3Qgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJ2xvZ2dlcicpLmNyZWF0ZUxvZ2dlcignLi9kZXZlbG9wbWVudC5sb2cnKTtcblxuXG5jb25zdCBiY3J5cHQgPSByZXF1aXJlKCdiY3J5cHQnKTtcbmNvbnN0IHtcbiAgY2hlY2ssXG4gIHZhbGlkYXRpb25SZXN1bHQsIGJvZHksXG59ID0gcmVxdWlyZSgnZXhwcmVzcy12YWxpZGF0b3InKTtcblxuY29uc3Qge1xuICBzYW5pdGl6ZUJvZHksXG59ID0gcmVxdWlyZSgnZXhwcmVzcy12YWxpZGF0b3InKTtcbmNvbnN0IF9yZXNwb25zZSA9IHJlcXVpcmUoJy4uL2hlbHBlcnMvcmVzcG9uc2UnKTtcbmNvbnN0IGRiID0gcmVxdWlyZSgnLi4vY29uZmlnL2RiJyk7XG5jb25zdCBVdGlscyA9IHJlcXVpcmUoJy4uL2hlbHBlcnMvdXRpbHMnKTtcbmNvbnN0IGF1dGhDaGVjayA9IHJlcXVpcmUoJy4uL21pZGRsZXdhcmVzL2F1dGhfY2hlY2snKTtcblxuLy8gY3JlYXRlIGEgbmV3IHVzZXJcbnJvdXRlci5wb3N0KCcvc2lnbnVwJyxcbiAgW1xuICAgIGNoZWNrKCdlbWFpbCcpLmV4aXN0cygpLndpdGhNZXNzYWdlKCdFbWFpbCBpcyByZXF1aXJlZCcpLFxuICAgIGNoZWNrKCdwYXNzd29yZCcpLmV4aXN0cygpLndpdGhNZXNzYWdlKCdQYXNzd29yZCBpcyByZXF1aXJlZCcpLFxuICAgIGNoZWNrKCdmaXJzdF9uYW1lJykuZXhpc3RzKCkud2l0aE1lc3NhZ2UoJ0ZpcnN0IG5hbWUgaXMgcmVxdWlyZWQnKSxcbiAgICBjaGVjaygnbGFzdF9uYW1lJykuZXhpc3RzKCkud2l0aE1lc3NhZ2UoJ0xhc3QgbmFtZSBpcyByZXF1aXJlZCcpLFxuICAgIGJvZHkoJ2VtYWlsJykubm90KCkuaXNFbXB0eSgpLmVzY2FwZSgpXG4gICAgICAuaXNFbWFpbCgpLFxuICAgIHNhbml0aXplQm9keSgnZW1haWwnKS5ub3JtYWxpemVFbWFpbCgpLnRyaW0oKSxcbiAgXSwgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGlvblJlc3VsdChyZXEpO1xuICAgIGlmICghZXJyb3JzLmlzRW1wdHkoKSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKF9yZXNwb25zZS5lcnJvcihlcnJvcnMpKTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oeyBlcnJvcnMsIG1zZzogJ1VzZXIgYXV0aCB2YWxpZGF0aW9uJyB9KTtcbiAgICBjb25zdCB7XG4gICAgICBlbWFpbCxcbiAgICAgIHBhc3N3b3JkLFxuICAgICAgZmlyc3RfbmFtZSxcbiAgICAgIGxhc3RfbmFtZSxcbiAgICB9ID0gcmVxLmJvZHk7XG4gICAgbGV0IGlzQWRtaW4gPSB0cnVlO1xuICAgIGNvbnN0IHNlYXJjaFF1ZXJ5ID0gYFNFTEVDVCAqIEZST00gdXNlcnMgV0hFUkUgZW1haWwgPSAnJHtlbWFpbH0nIGA7XG5cbiAgICBkYi5xdWVyeShzZWFyY2hRdWVyeSkudGhlbigocmVzcCkgPT4ge1xuICAgICAgaWYgKHJlc3Aucm93Q291bnQgPiAwKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAzKS5qc29uKF9yZXNwb25zZS5lcnJvcignRW1haWwgYWxyZWFkeSBleGlzdHMnKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBmaW5kIHVzZXJzXG4gICAgICAgIGRiLnF1ZXJ5KCdTRUxFQ1QgKiBGUk9NIHVzZXJzJykudGhlbigodXNlcnMpID0+IHtcbiAgICAgICAgICBpZiAodXNlcnMucm93Q291bnQgPiAwKSB7XG4gICAgICAgICAgICBpc0FkbWluID0gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJjcnlwdC5oYXNoKHBhc3N3b3JkLCAxMCwgKGVyciwgaGFzaCkgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbihfcmVzcG9uc2UuZXJyb3IoZXJyKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBjb25zdCB1bmlxdWkgPSBVdGlscy5yYW5kb21TdHJpbmcoMjAwKTtcbiAgICAgICAgICAgICAgY29uc3QgcXVlcnkgPSB7XG4gICAgICAgICAgICAgICAgdGV4dDogJ0lOU0VSVCBJTlRPIHVzZXJzKHVzZXJfaWQsZmlyc3RfbmFtZSxsYXN0X25hbWUsZW1haWwscGFzc3dvcmQsaXNfYWRtaW4sYWRkcmVzcykgVkFMVUVTKCQxLCQyLCQzLCQ0LCQ1LCQ2LCQ3KSBSRVRVUk5JTkcgKicsXG4gICAgICAgICAgICAgICAgdmFsdWVzOiBbdW5pcXVpLnRyaW1SaWdodCgpLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUsIGVtYWlsLCBoYXNoLCBpc0FkbWluLCAnc29tZXdoZXJlJ10sXG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgIGRiLnF1ZXJ5KHF1ZXJ5KVxuICAgICAgICAgICAgICAgIC50aGVuKChyZXNwbykgPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc3Qgand0ZGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgZW1haWw6IHJlc3BvLnJvd3NbMF0uZW1haWwsXG4gICAgICAgICAgICAgICAgICAgIHVzZXJJZDogcmVzcG8ucm93c1swXS51c2VyX2lkLFxuICAgICAgICAgICAgICAgICAgICBpc19hZG1pbjogcmVzcG8ucm93c1swXS5pc19hZG1pbixcbiAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICBjb25zdCB0b2tlbiA9IFV0aWxzLnNpZ25Ub2tlbihqd3RkYXRhKTtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgICAgICAgICAgICAgIHVzZXJfaWQ6IHJlc3BvLnJvd3NbMF0udXNlcl9pZCxcbiAgICAgICAgICAgICAgICAgICAgaXNfYWRtaW46IHJlc3BvLnJvd3NbMF0uaXNfYWRtaW4sXG4gICAgICAgICAgICAgICAgICAgIHRva2VuLFxuICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKF9yZXNwb25zZS5zdWNjZXNzKGRhdGEpKTtcbiAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICAgICAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdTb21ldGhpbmcgd2VudCB3cm9uZycpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICBsb2dnZXIuaW5mbyhpc0FkbWluKTtcbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnIpO1xuICAgICAgICAgIHJlcy5zdGF0dXMoNTA1KS5qc29uKF9yZXNwb25zZS5lcnJvcignQ291bGQgbm90IGZldGNoIHVzZXJzJykpO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gZW5kIGZpbmQgdXNlcnNcbiAgICAgIH1cbiAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICByZXMuanNvbihfcmVzcG9uc2UuZXJyb3IoZXJyKSk7XG4gICAgfSk7XG5cblxuICAgIC8vIHJlcy5zZW5kKHJlc3BvbnNlLmVycm9yKCdTb21ldGhpbmcgd2VudCB3cm9uZycpKVxuICB9KS5wb3N0KCcvc2lnbmluJywgYm9keSgnZW1haWwnKS5ub3QoKS5pc0VtcHR5KCkuZXNjYXBlKClcbiAgLmlzRW1haWwoKSxcbihyZXEsIHJlcykgPT4ge1xuICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0aW9uUmVzdWx0KHJlcSk7XG4gIGlmICghZXJyb3JzLmlzRW1wdHkoKSkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuc2VuZChfcmVzcG9uc2UuZXJyb3IoZXJyb3JzKSk7XG4gIH1cbiAgY29uc3Qge1xuICAgIGVtYWlsLFxuICAgIHBhc3N3b3JkLFxuICB9ID0gcmVxLmJvZHk7XG4gIGNvbnN0IHNlYXJjaFF1ZXJ5ID0gYFNFTEVDVCAqIEZST00gdXNlcnMgV0hFUkUgZW1haWwgPSAnJHtlbWFpbH0nIExJTUlUIDFgO1xuXG4gIGRiLnF1ZXJ5KHNlYXJjaFF1ZXJ5KS50aGVuKChyZXNwKSA9PiB7XG4gICAgaWYgKHJlc3Aucm93Q291bnQgPD0gMCkge1xuICAgICAgcmVzLnN0YXR1cyg0MDMpLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdFbWFpbCBkb2VzIG5vdCBleGlzdCcpKTtcbiAgICB9XG5cbiAgICBiY3J5cHQuY29tcGFyZShwYXNzd29yZCwgcmVzcC5yb3dzWzBdLnBhc3N3b3JkLCAoZXJyLCByZXN1bHQpID0+IHtcbiAgICAgIC8vIHJlcyA9PSB0cnVlXG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKF9yZXNwb25zZS5lcnJvcignRmFpbGVkIHdpdGggY29kZSB4KDJlMngpJykpO1xuICAgICAgfVxuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICBjb25zdCBqd3RkYXRhID0ge1xuICAgICAgICAgIGVtYWlsOiByZXNwLnJvd3NbMF0uZW1haWwsXG4gICAgICAgICAgdXNlcklkOiByZXNwLnJvd3NbMF0udXNlcl9pZCxcbiAgICAgICAgICBpc19hZG1pbjogcmVzcC5yb3dzWzBdLmlzX2FkbWluLFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCB0b2tlbiA9IFV0aWxzLnNpZ25Ub2tlbihqd3RkYXRhKTtcbiAgICAgICAgcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgJHt0b2tlbn1gO1xuICAgICAgICBjb25zdCBkYXRhID0ge1xuICAgICAgICAgIHVzZXJfaWQ6IHJlc3Aucm93c1swXS51c2VyX2lkLFxuICAgICAgICAgIGlzX2FkbWluOiByZXNwLnJvd3NbMF0uaXNfYWRtaW4sXG4gICAgICAgICAgdG9rZW4sXG4gICAgICAgIH07XG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKF9yZXNwb25zZS5zdWNjZXNzKGRhdGEpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59KS5wb3N0KCcvYWRtaW4vOnVzZXJJZCcsIGF1dGhDaGVjaywgKHJlcSwgcmVzKSA9PiB7XG4gIC8vIG1ha2UgdXNlciBhbiBhZG1pblxuICBjb25zdCB0b0JlQWRtaW4gPSByZXEucGFyYW1zLnVzZXJJZDtcbiAgY29uc3QgeyBkYXRhIH0gPSByZXEuZGVjb2RlZDtcbiAgY29uc3QgYWRtaW4gPSBkYXRhLmlzX2FkbWluO1xuXG4gIGxvZ2dlci5pbmZvKGFkbWluKTtcbiAgaWYgKGFkbWluKSB7XG4gICAgZGIucXVlcnkoYFNFTEVDVCAqIEZST00gdXNlcnMgV0hFUkUgdXNlcl9pZCA9ICcke3RvQmVBZG1pbn0nIEFORCBpc19hZG1pbj0nJHtmYWxzZX0nYCkudGhlbigocmVzcCkgPT4ge1xuICAgICAgaWYgKHJlc3Aucm93Q291bnQgPiAwKSB7XG4gICAgICAgIGRiLnF1ZXJ5KGBVUERBVEUgdXNlcnMgU0VUIGlzX2FkbWluPScke3RydWV9JyBXSEVSRSB1c2VyX2lkID0gJyR7dG9CZUFkbWlufScgUkVUVVJOSU5HICpgKS50aGVuKChuZXdBZG1pbkRhdGEpID0+IHtcbiAgICAgICAgICBpZiAobmV3QWRtaW5EYXRhLnJvd0NvdW50ID4gMCkge1xuICAgICAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oX3Jlc3BvbnNlLnN1Y2Nlc3MobmV3QWRtaW5EYXRhLnJvd3NbMF0pKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdGYWlsZWQgdG8gYXNzaWduIHJvbGUnKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KS5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdPcHBzISBTb21ldGhpbmcgd2VudCB3cm9uZycpKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc3RhdHVzKDQwMykuanNvbihfcmVzcG9uc2UuZXJyb3IoJ0Nhbm5vdCByZS1hc3NpZ24gcm9sZSB0byB1c2VyJykpO1xuICAgICAgfVxuICAgIH0pLmNhdGNoKCgpID0+IHtcbiAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKF9yZXNwb25zZS5lcnJvcignT3BwcyEgU29tZXRoaW5nIHdlbnQgd3JvbmcnKSk7XG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgcmVzLnN0YXR1cyg1MDUpLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdZb3VyIHBsYW5zIGZhaWxlZCwgd2UgaGF2ZSBhIHN0cm9uZ2VyIGFsZ29yaXRobScpKTtcbiAgfVxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gcm91dGVyO1xuIl19