"use strict";

/* eslint-disable consistent-return */

/* eslint-disable no-underscore-dangle */
var express = require('express');

var router = express.Router();

var logger = require('logger').createLogger('./development.log');

var bcrypt = require('bcrypt');

var _require = require('express-validator'),
    check = _require.check,
    validationResult = _require.validationResult,
    body = _require.body;

var _require2 = require('express-validator'),
    sanitizeBody = _require2.sanitizeBody;

var _response = require('../helpers/response');

var db = require('../config/db');

var Utils = require('../helpers/utils');

var authCheck = require('../middlewares/auth_check'); // create a new user


router.post('/signup', [check('email').exists().withMessage('Email is required'), check('password').exists().withMessage('Password is required'), check('firstName').exists().withMessage('First name is required'), check('lastName').exists().withMessage('Last name is required'), body('email').not().isEmpty().escape().isEmail(), sanitizeBody('email').normalizeEmail().trim()], function (req, res) {
  var errors = validationResult(req);

  if (!errors.isEmpty()) {
    return res.status(404).json(_response.error(errors));
  }

  logger.info({
    errors: errors,
    msg: 'User auth validation'
  });
  var _req$body = req.body,
      email = _req$body.email,
      password = _req$body.password,
      firstName = _req$body.firstName,
      lastName = _req$body.lastName; // console.log(email)

  var searchQuery = "SELECT * FROM users WHERE email = '".concat(email, "' ");
  db.query(searchQuery).then(function (resp) {
    if (resp.rowCount > 0) {
      res.status(403).json(_response.error('Email already exists'));
    } else {
      bcrypt.hash(password, 10, function (err, hash) {
        if (err) {
          res.status(500).json(_response.error(err));
        } else {
          var uniqui = Utils.randomString(200);
          var query = {
            text: 'INSERT INTO users(user_id,first_name,last_name,email,password,is_admin,address) VALUES($1,$2,$3,$4,$5,$6,$7) RETURNING *',
            values: [uniqui.trimRight(), firstName, lastName, email, hash, false, 'somewhere']
          };
          db.query(query).then(function (respo) {
            var jwtdata = {
              email: respo.rows[0].email,
              userId: respo.rows[0].user_id,
              is_admin: respo.rows[0].is_admin
            };
            var token = Utils.signToken(jwtdata);
            var data = {
              user_id: respo.rows[0].user_id,
              is_admin: respo.rows[0].is_admin,
              token: token
            };
            res.status(201).json(_response.success(data));
          })["catch"](function (e) {
            logger.error(e);
            res.status(500).json(_response.error('Something went wrong'));
          });
        }
      });
    }
  })["catch"](function (err) {
    res.json(_response.error(err));
  }); // res.send(response.error('Something went wrong'))
}).post('/signin', body('email').not().isEmpty().escape().isEmail(), function (req, res) {
  var errors = validationResult(req);

  if (!errors.isEmpty()) {
    return res.status(403).send(_response.error(errors));
  }

  var _req$body2 = req.body,
      email = _req$body2.email,
      password = _req$body2.password;
  var searchQuery = "SELECT password,user_id,is_admin FROM users WHERE email = '".concat(email, "' LIMIT 1");
  db.query(searchQuery).then(function (resp) {
    if (resp.rowCount <= 0) {
      res.status(403).json(_response.error('Email does not exist'));
    }

    bcrypt.compare(password, resp.rows[0].password, function (err, result) {
      // res == true
      if (err) {
        res.status(401).json(_response.error('Failed with code x(2e2x)'));
      }

      if (result) {
        var jwtdata = {
          email: resp.rows[0].email,
          userId: resp.rows[0].user_id,
          is_admin: resp.rows[0].is_admin
        };
        var token = Utils.signToken(jwtdata);
        req.headers.authorization = "Bearer ".concat(token);
        var data = {
          user_id: resp.rows[0].user_id,
          is_admin: resp.rows[0].is_admin,
          token: token
        };
        res.status(200).json(_response.success(data));
      }
    });
  });
}).post('/admin/:userId', authCheck, function (req, res) {
  // make user an admin
  var toBeAdmin = req.params.userId;
  var data = req.decoded.data;
  var admin = data.is_admin;
  logger.info(admin);

  if (admin) {
    db.query("SELECT * FROM users WHERE user_id = '".concat(toBeAdmin, "' AND is_admin='", false, "'")).then(function (resp) {
      if (resp.rowCount > 0) {
        db.query("UPDATE users SET is_admin='".concat(true, "' WHERE user_id = '", toBeAdmin, "' RETURNING *")).then(function (newAdminData) {
          if (newAdminData.rowCount > 0) {
            res.status(200).json(_response.success(newAdminData.rows[0]));
          } else {
            res.status(500).json(_response.error('Failed to assign role'));
          }
        })["catch"](function () {
          res.status(401).json(_response.error('Opps! Something went wrong'));
        });
      } else {
        res.status(403).json(_response.error('Cannot re-assign role to user'));
      }
    })["catch"](function () {
      res.status(401).json(_response.error('Opps! Something went wrong'));
    });
  } else {
    res.status(505).json(_response.error('Your plans failed, we have a stronger algorithm'));
  }
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2FwcC9jb250cm9sbGVycy91c2VyLmpzIl0sIm5hbWVzIjpbImV4cHJlc3MiLCJyZXF1aXJlIiwicm91dGVyIiwiUm91dGVyIiwibG9nZ2VyIiwiY3JlYXRlTG9nZ2VyIiwiYmNyeXB0IiwiY2hlY2siLCJ2YWxpZGF0aW9uUmVzdWx0IiwiYm9keSIsInNhbml0aXplQm9keSIsIl9yZXNwb25zZSIsImRiIiwiVXRpbHMiLCJhdXRoQ2hlY2siLCJwb3N0IiwiZXhpc3RzIiwid2l0aE1lc3NhZ2UiLCJub3QiLCJpc0VtcHR5IiwiZXNjYXBlIiwiaXNFbWFpbCIsIm5vcm1hbGl6ZUVtYWlsIiwidHJpbSIsInJlcSIsInJlcyIsImVycm9ycyIsInN0YXR1cyIsImpzb24iLCJlcnJvciIsImluZm8iLCJtc2ciLCJlbWFpbCIsInBhc3N3b3JkIiwiZmlyc3ROYW1lIiwibGFzdE5hbWUiLCJzZWFyY2hRdWVyeSIsInF1ZXJ5IiwidGhlbiIsInJlc3AiLCJyb3dDb3VudCIsImhhc2giLCJlcnIiLCJ1bmlxdWkiLCJyYW5kb21TdHJpbmciLCJ0ZXh0IiwidmFsdWVzIiwidHJpbVJpZ2h0IiwicmVzcG8iLCJqd3RkYXRhIiwicm93cyIsInVzZXJJZCIsInVzZXJfaWQiLCJpc19hZG1pbiIsInRva2VuIiwic2lnblRva2VuIiwiZGF0YSIsInN1Y2Nlc3MiLCJlIiwic2VuZCIsImNvbXBhcmUiLCJyZXN1bHQiLCJoZWFkZXJzIiwiYXV0aG9yaXphdGlvbiIsInRvQmVBZG1pbiIsInBhcmFtcyIsImRlY29kZWQiLCJhZG1pbiIsIm5ld0FkbWluRGF0YSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBQ0E7QUFDQSxJQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxTQUFELENBQXZCOztBQUVBLElBQU1DLE1BQU0sR0FBR0YsT0FBTyxDQUFDRyxNQUFSLEVBQWY7O0FBQ0EsSUFBTUMsTUFBTSxHQUFHSCxPQUFPLENBQUMsUUFBRCxDQUFQ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QUFyQjtBQUNEO0FBQ0YsU0FORCxXQU1TLFlBQU07QUFDYkosVUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJqQixTQUFTLENBQUNrQixLQUFWLENBQWdCLDRCQUFoQixDQUFyQjtBQUNELFNBUkQ7QUFTRCxPQVZELE1BVU87QUFDTEosUUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJqQixTQUFTLENBQUNrQixLQUFWLENBQWdCLCtCQUFoQixDQUFyQjtBQUNEO0FBQ0YsS0FkRCxXQWNTLFlBQU07QUFDYkosTUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJqQixTQUFTLENBQUNrQixLQUFWLENBQWdCLDRCQUFoQixDQUFyQjtBQUNELEtBaEJEO0FBaUJELEdBbEJELE1Ba0JPO0FBQ0xKLElBQUFBLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCakIsU0FBUyxDQUFDa0IsS0FBVixDQUFnQixpREFBaEIsQ0FBckI7QUFDRDtBQUNGLENBcklEO0FBdUlBd0MsTUFBTSxDQUFDQyxPQUFQLEdBQWlCcEUsTUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBjb25zaXN0ZW50LXJldHVybiAqL1xuLyogZXNsaW50LWRpc2FibGUgbm8tdW5kZXJzY29yZS1kYW5nbGUgKi9cbmNvbnN0IGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XG5cbmNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKCdsb2dnZXInKS5jcmVhdGVMb2dnZXIoJy4vZGV2ZWxvcG1lbnQubG9nJyk7XG5cblxuY29uc3QgYmNyeXB0ID0gcmVxdWlyZSgnYmNyeXB0Jyk7XG5jb25zdCB7XG4gIGNoZWNrLFxuICB2YWxpZGF0aW9uUmVzdWx0LCBib2R5LFxufSA9IHJlcXVpcmUoJ2V4cHJlc3MtdmFsaWRhdG9yJyk7XG5cbmNvbnN0IHtcbiAgc2FuaXRpemVCb2R5LFxufSA9IHJlcXVpcmUoJ2V4cHJlc3MtdmFsaWRhdG9yJyk7XG5jb25zdCBfcmVzcG9uc2UgPSByZXF1aXJlKCcuLi9oZWxwZXJzL3Jlc3BvbnNlJyk7XG5jb25zdCBkYiA9IHJlcXVpcmUoJy4uL2NvbmZpZy9kYicpO1xuY29uc3QgVXRpbHMgPSByZXF1aXJlKCcuLi9oZWxwZXJzL3V0aWxzJyk7XG5jb25zdCBhdXRoQ2hlY2sgPSByZXF1aXJlKCcuLi9taWRkbGV3YXJlcy9hdXRoX2NoZWNrJyk7XG5cbi8vIGNyZWF0ZSBhIG5ldyB1c2VyXG5yb3V0ZXIucG9zdCgnL3NpZ251cCcsXG4gIFtcbiAgICBjaGVjaygnZW1haWwnKS5leGlzdHMoKS53aXRoTWVzc2FnZSgnRW1haWwgaXMgcmVxdWlyZWQnKSxcbiAgICBjaGVjaygncGFzc3dvcmQnKS5leGlzdHMoKS53aXRoTWVzc2FnZSgnUGFzc3dvcmQgaXMgcmVxdWlyZWQnKSxcbiAgICBjaGVjaygnZmlyc3ROYW1lJykuZXhpc3RzKCkud2l0aE1lc3NhZ2UoJ0ZpcnN0IG5hbWUgaXMgcmVxdWlyZWQnKSxcbiAgICBjaGVjaygnbGFzdE5hbWUnKS5leGlzdHMoKS53aXRoTWVzc2FnZSgnTGFzdCBuYW1lIGlzIHJlcXVpcmVkJyksXG4gICAgYm9keSgnZW1haWwnKS5ub3QoKS5pc0VtcHR5KCkuZXNjYXBlKClcbiAgICAgIC5pc0VtYWlsKCksXG4gICAgc2FuaXRpemVCb2R5KCdlbWFpbCcpLm5vcm1hbGl6ZUVtYWlsKCkudHJpbSgpLFxuICBdLCAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0aW9uUmVzdWx0KHJlcSk7XG4gICAgaWYgKCFlcnJvcnMuaXNFbXB0eSgpKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oX3Jlc3BvbnNlLmVycm9yKGVycm9ycykpO1xuICAgIH1cbiAgICBsb2dnZXIuaW5mbyh7IGVycm9ycywgbXNnOiAnVXNlciBhdXRoIHZhbGlkYXRpb24nIH0pO1xuICAgIGNvbnN0IHtcbiAgICAgIGVtYWlsLFxuICAgICAgcGFzc3dvcmQsXG4gICAgICBmaXJzdE5hbWUsXG4gICAgICBsYXN0TmFtZSxcbiAgICB9ID0gcmVxLmJvZHk7XG5cbiAgICAvLyBjb25zb2xlLmxvZyhlbWFpbClcbiAgICBjb25zdCBzZWFyY2hRdWVyeSA9IGBTRUxFQ1QgKiBGUk9NIHVzZXJzIFdIRVJFIGVtYWlsID0gJyR7ZW1haWx9JyBgO1xuXG4gICAgZGIucXVlcnkoc2VhcmNoUXVlcnkpLnRoZW4oKHJlc3ApID0+IHtcbiAgICAgIGlmIChyZXNwLnJvd0NvdW50ID4gMCkge1xuICAgICAgICByZXMuc3RhdHVzKDQwMykuanNvbihfcmVzcG9uc2UuZXJyb3IoJ0VtYWlsIGFscmVhZHkgZXhpc3RzJykpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYmNyeXB0Lmhhc2gocGFzc3dvcmQsIDEwLCAoZXJyLCBoYXNoKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oX3Jlc3BvbnNlLmVycm9yKGVycikpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCB1bmlxdWkgPSBVdGlscy5yYW5kb21TdHJpbmcoMjAwKTtcbiAgICAgICAgICAgIGNvbnN0IHF1ZXJ5ID0ge1xuICAgICAgICAgICAgICB0ZXh0OiAnSU5TRVJUIElOVE8gdXNlcnModXNlcl9pZCxmaXJzdF9uYW1lLGxhc3RfbmFtZSxlbWFpbCxwYXNzd29yZCxpc19hZG1pbixhZGRyZXNzKSBWQUxVRVMoJDEsJDIsJDMsJDQsJDUsJDYsJDcpIFJFVFVSTklORyAqJyxcbiAgICAgICAgICAgICAgdmFsdWVzOiBbdW5pcXVpLnRyaW1SaWdodCgpLCBmaXJzdE5hbWUsIGxhc3ROYW1lLCBlbWFpbCwgaGFzaCwgZmFsc2UsICdzb21ld2hlcmUnXSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBkYi5xdWVyeShxdWVyeSlcbiAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgand0ZGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiByZXNwby5yb3dzWzBdLmVtYWlsLFxuICAgICAgICAgICAgICAgICAgdXNlcklkOiByZXNwby5yb3dzWzBdLnVzZXJfaWQsXG4gICAgICAgICAgICAgICAgICBpc19hZG1pbjogcmVzcG8ucm93c1swXS5pc19hZG1pbixcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGNvbnN0IHRva2VuID0gVXRpbHMuc2lnblRva2VuKGp3dGRhdGEpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgICAgICAgICAgICB1c2VyX2lkOiByZXNwby5yb3dzWzBdLnVzZXJfaWQsXG4gICAgICAgICAgICAgICAgICBpc19hZG1pbjogcmVzcG8ucm93c1swXS5pc19hZG1pbixcbiAgICAgICAgICAgICAgICAgIHRva2VuLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24oX3Jlc3BvbnNlLnN1Y2Nlc3MoZGF0YSkpO1xuICAgICAgICAgICAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgICAgICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbihfcmVzcG9uc2UuZXJyb3IoJ1NvbWV0aGluZyB3ZW50IHdyb25nJykpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIHJlcy5qc29uKF9yZXNwb25zZS5lcnJvcihlcnIpKTtcbiAgICB9KTtcblxuXG4gICAgLy8gcmVzLnNlbmQocmVzcG9uc2UuZXJyb3IoJ1NvbWV0aGluZyB3ZW50IHdyb25nJykpXG4gIH0pLnBvc3QoJy9zaWduaW4nLCBib2R5KCdlbWFpbCcpLm5vdCgpLmlzRW1wdHkoKS5lc2NhcGUoKVxuICAuaXNFbWFpbCgpLFxuKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IGVycm9ycyA9IHZhbGlkYXRpb25SZXN1bHQocmVxKTtcbiAgaWYgKCFlcnJvcnMuaXNFbXB0eSgpKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5zZW5kKF9yZXNwb25zZS5lcnJvcihlcnJvcnMpKTtcbiAgfVxuICBjb25zdCB7XG4gICAgZW1haWwsXG4gICAgcGFzc3dvcmQsXG4gIH0gPSByZXEuYm9keTtcbiAgY29uc3Qgc2VhcmNoUXVlcnkgPSBgU0VMRUNUIHBhc3N3b3JkLHVzZXJfaWQsaXNfYWRtaW4gRlJPTSB1c2VycyBXSEVSRSBlbWFpbCA9ICcke2VtYWlsfScgTElNSVQgMWA7XG5cbiAgZGIucXVlcnkoc2VhcmNoUXVlcnkpLnRoZW4oKHJlc3ApID0+IHtcbiAgICBpZiAocmVzcC5yb3dDb3VudCA8PSAwKSB7XG4gICAgICByZXMuc3RhdHVzKDQwMykuanNvbihfcmVzcG9uc2UuZXJyb3IoJ0VtYWlsIGRvZXMgbm90IGV4aXN0JykpO1xuICAgIH1cblxuICAgIGJjcnlwdC5jb21wYXJlKHBhc3N3b3JkLCByZXNwLnJvd3NbMF0ucGFzc3dvcmQsIChlcnIsIHJlc3VsdCkgPT4ge1xuICAgICAgLy8gcmVzID09IHRydWVcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdGYWlsZWQgd2l0aCBjb2RlIHgoMmUyeCknKSk7XG4gICAgICB9XG4gICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgIGNvbnN0IGp3dGRhdGEgPSB7XG4gICAgICAgICAgZW1haWw6IHJlc3Aucm93c1swXS5lbWFpbCxcbiAgICAgICAgICB1c2VySWQ6IHJlc3Aucm93c1swXS51c2VyX2lkLFxuICAgICAgICAgIGlzX2FkbWluOiByZXNwLnJvd3NbMF0uaXNfYWRtaW4sXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IHRva2VuID0gVXRpbHMuc2lnblRva2VuKGp3dGRhdGEpO1xuICAgICAgICByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7XG4gICAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgICAgdXNlcl9pZDogcmVzcC5yb3dzWzBdLnVzZXJfaWQsXG4gICAgICAgICAgaXNfYWRtaW46IHJlc3Aucm93c1swXS5pc19hZG1pbixcbiAgICAgICAgICB0b2tlbixcbiAgICAgICAgfTtcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oX3Jlc3BvbnNlLnN1Y2Nlc3MoZGF0YSkpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn0pLnBvc3QoJy9hZG1pbi86dXNlcklkJywgYXV0aENoZWNrLCAocmVxLCByZXMpID0+IHtcbiAgLy8gbWFrZSB1c2VyIGFuIGFkbWluXG4gIGNvbnN0IHRvQmVBZG1pbiA9IHJlcS5wYXJhbXMudXNlcklkO1xuICBjb25zdCB7IGRhdGEgfSA9IHJlcS5kZWNvZGVkO1xuICBjb25zdCBhZG1pbiA9IGRhdGEuaXNfYWRtaW47XG5cbiAgbG9nZ2VyLmluZm8oYWRtaW4pO1xuICBpZiAoYWRtaW4pIHtcbiAgICBkYi5xdWVyeShgU0VMRUNUICogRlJPTSB1c2VycyBXSEVSRSB1c2VyX2lkID0gJyR7dG9CZUFkbWlufScgQU5EIGlzX2FkbWluPScke2ZhbHNlfSdgKS50aGVuKChyZXNwKSA9PiB7XG4gICAgICBpZiAocmVzcC5yb3dDb3VudCA+IDApIHtcbiAgICAgICAgZGIucXVlcnkoYFVQREFURSB1c2VycyBTRVQgaXNfYWRtaW49JyR7dHJ1ZX0nIFdIRVJFIHVzZXJfaWQgPSAnJHt0b0JlQWRtaW59JyBSRVRVUk5JTkcgKmApLnRoZW4oKG5ld0FkbWluRGF0YSkgPT4ge1xuICAgICAgICAgIGlmIChuZXdBZG1pbkRhdGEucm93Q291bnQgPiAwKSB7XG4gICAgICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbihfcmVzcG9uc2Uuc3VjY2VzcyhuZXdBZG1pbkRhdGEucm93c1swXSkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbihfcmVzcG9uc2UuZXJyb3IoJ0ZhaWxlZCB0byBhc3NpZ24gcm9sZScpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLmNhdGNoKCgpID0+IHtcbiAgICAgICAgICByZXMuc3RhdHVzKDQwMSkuanNvbihfcmVzcG9uc2UuZXJyb3IoJ09wcHMhIFNvbWV0aGluZyB3ZW50IHdyb25nJykpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAzKS5qc29uKF9yZXNwb25zZS5lcnJvcignQ2Fubm90IHJlLWFzc2lnbiByb2xlIHRvIHVzZXInKSk7XG4gICAgICB9XG4gICAgfSkuY2F0Y2goKCkgPT4ge1xuICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oX3Jlc3BvbnNlLmVycm9yKCdPcHBzISBTb21ldGhpbmcgd2VudCB3cm9uZycpKTtcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICByZXMuc3RhdHVzKDUwNSkuanNvbihfcmVzcG9uc2UuZXJyb3IoJ1lvdXIgcGxhbnMgZmFpbGVkLCB3ZSBoYXZlIGEgc3Ryb25nZXIgYWxnb3JpdGhtJykpO1xuICB9XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSByb3V0ZXI7XG4iXX0=