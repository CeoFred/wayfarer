"use strict";

var express = require('express');

var logger = require('logger').createLogger('./development.log');

var router = express.Router();

var response = require('../helpers/response');

var db = require('../config/db');

var Utils = require('../helpers/utils');

var authCheck = require('../middlewares/auth_check');

router.post('/', authCheck, function (req, res) {
  // new trip
  var _req$body = req.body,
      origin = _req$body.origin,
      destination = _req$body.destination,
      fare = _req$body.fare,
      trip_date = _req$body.trip_date;
  var data = req.decoded.data;

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  var uniqui = Utils.randomString(200);
  var query = {
    text: 'INSERT INTO trips(user_id,origin,destination,trip_date,fare,trip_id,status) VALUES($1,$2,$3,$4,$5,$6,$7) RETURNING *',
    values: [data.user_id, origin, destination, trip_date, fare, uniqui.trimRight(), 'Active']
  };
  db.query(query).then(function (resp) {
    var trip_data = resp.rows[0];
    trip_data.id = resp.rows[0].booking_id;
    res.status(201).json(response.success(trip_data));
  })["catch"](function (err) {
    console.log(JSON.stringify(err));
    res.status(500).json(response.error('Something went wrong'));
  });
}).get('/', function (req, res) {
  // get all trips available
  db.query("SELECT * FROM trips WHERE status = 'Active' ").then(function (resp) {
    res.status(200).json(response.success(resp.rows));
  })["catch"](function (err) {
    logger.error(err);
    console.log(JSON.stringify(err));
    res.status(500).json(response.error('Failed to fetch trips'));
  });
}).patch('/:tripId', authCheck, function (req, res) {
  // cancel a trip
  var tripId = req.params.tripId;
  var data = req.decoded.data;

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  db.query("SELECT * FROM trips WHERE status = 'Active' AND trip_id = '".concat(tripId, "' ")).then(function (resp) {
    if (resp.rowCount <= 0) {
      res.status(404).json(response.error('Trip Not found'));
    } else {
      db.query("UPDATE trips SET status = 'cancelled' WHERE trip_id = '".concat(tripId, "' AND status = 'Active'")).then(function (busData) {
        res.status(200).json(response.success({
          message: 'Trip cancelled successfully',
          busData: busData
        }));
      })["catch"](function (err) {
        res.status(500).json(response.error({
          message: 'Trip failed to cancel'
        }));
        logger.error({
          err: err,
          message: 'while canceling trip'
        });
      });
    }
  })["catch"](function (err) {
    logger.error(err);
    res.status(500).json(response.error('Failed to fetch trips'));
  });
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2FwcC9jb250cm9sbGVycy90cmlwcy5qcyJdLCJuYW1lcyI6WyJleHByZXNzIiwicmVxdWlyZSIsImxvZ2dlciIsImNyZWF0ZUxvZ2dlciIsInJvdXRlciIsIlJvdXRlciIsInJlc3BvbnNlIiwiZGIiLCJVdGlscyIsImF1dGhDaGVjayIsInBvc3QiLCJyZXEiLCJyZXMiLCJib2R5Iiwib3JpZ2luIiwiZGVzdGluYXRpb24iLCJmYXJlIiwidHJpcF9kYXRlIiwiZGF0YSIsImRlY29kZWQiLCJpc19hZG1pbiIsInN0YXR1cyIsImpzb24iLCJlcnJvciIsInVuaXF1aSIsInJhbmRvbVN0cmluZyIsInF1ZXJ5IiwidGV4dCIsInZhbHVlcyIsInVzZXJfaWQiLCJ0cmltUmlnaHQiLCJ0aGVuIiwicmVzcCIsInRyaXBfZGF0YSIsInJvd3MiLCJpZCIsImJvb2tpbmdfaWQiLCJzdWNjZXNzIiwiZXJyIiwiY29uc29sZSIsImxvZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJnZXQiLCJwYXRjaCIsInRyaXBJZCIsInBhcmFtcyIsInJvd0NvdW50IiwiYnVzRGF0YSIsIm1lc3NhZ2UiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLFNBQUQsQ0FBdkI7O0FBQ0EsSUFBTUMsTUFBTSxHQUFHRCxPQUFPLENBQUMsUUFBRCxDQUFQLENBQWtCRSxZQUFsQixDQUErQixtQkFBL0IsQ0FBZjs7QUFFQSxJQUFNQyxNQUFNLEdBQUdKLE9BQU8sQ0FBQ0ssTUFBUixFQUFmOztBQUNBLElBQU1DLFFBQVEsR0FBR0wsT0FBTyxDQUFDLHFCQUFELENBQXhCOztBQUNBLElBQU1NLEVBQUUsR0FBR04sT0FBTyxDQUFDLGNBQUQsQ0FBbEI7O0FBQ0EsSUFBTU8sS0FBSyxHQUFHUCxPQUFPLENBQUMsa0JBQUQsQ0FBckI7O0FBRUEsSUFBTVEsU0FBUyxHQUFHUixPQUFPLENBQUMsMkJBQUQsQ0FBekI7O0FBRUFH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RyxFQUFIQSxHQUFGO0FBQU9XLFVBQUFBLE9BQU8sRUFBRTtBQUFoQixTQUFiO0FBQ0QsT0FMRDtBQU1EO0FBQ0YsR0FYRCxXQVdTLFVBQUNYLEdBQUQsRUFBUztBQUNoQnBDLElBQUFBLE1BQU0sQ0FBQ3FCLEtBQVAsQ0FBYWUsR0FBYjtBQUVBMUIsSUFBQUEsR0FBRyxDQUFDUyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJoQixRQUFRLENBQUNpQixLQUFULENBQWUsdUJBQWYsQ0FBckI7QUFDRCxHQWZEO0FBZ0JELENBOUREO0FBZ0VBMkIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCL0MsTUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xuY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnbG9nZ2VyJykuY3JlYXRlTG9nZ2VyKCcuL2RldmVsb3BtZW50LmxvZycpO1xuXG5jb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuY29uc3QgcmVzcG9uc2UgPSByZXF1aXJlKCcuLi9oZWxwZXJzL3Jlc3BvbnNlJyk7XG5jb25zdCBkYiA9IHJlcXVpcmUoJy4uL2NvbmZpZy9kYicpO1xuY29uc3QgVXRpbHMgPSByZXF1aXJlKCcuLi9oZWxwZXJzL3V0aWxzJyk7XG5cbmNvbnN0IGF1dGhDaGVjayA9IHJlcXVpcmUoJy4uL21pZGRsZXdhcmVzL2F1dGhfY2hlY2snKTtcblxucm91dGVyLnBvc3QoJy8nLCBhdXRoQ2hlY2ssIChyZXEsIHJlcykgPT4ge1xuICAvLyBuZXcgdHJpcFxuICBjb25zdCB7XG4gICAgb3JpZ2luLFxuICAgIGRlc3RpbmF0aW9uLFxuICAgIGZhcmUsXG4gICAgdHJpcF9kYXRlLFxuXG4gIH0gPSByZXEuYm9keTtcbiAgY29uc3QgeyBkYXRhIH0gPSByZXEuZGVjb2RlZDtcbiAgaWYgKCFkYXRhLmlzX2FkbWluKSB7XG4gICAgcmVzLnN0YXR1cyg0MDEpLmpzb24ocmVzcG9uc2UuZXJyb3IoJ0FjY2VzcyBEZW5pZWQnKSk7XG4gIH1cblxuICBjb25zdCB1bmlxdWkgPSBVdGlscy5yYW5kb21TdHJpbmcoMjAwKTtcblxuICBjb25zdCBxdWVyeSA9IHtcbiAgICB0ZXh0OiAnSU5TRVJUIElOVE8gdHJpcHModXNlcl9pZCxvcmlnaW4sZGVzdGluYXRpb24sdHJpcF9kYXRlLGZhcmUsdHJpcF9pZCxzdGF0dXMpIFZBTFVFUygkMSwkMiwkMywkNCwkNSwkNiwkNykgUkVUVVJOSU5HIConLFxuICAgIHZhbHVlczogW2RhdGEudXNlcl9pZCwgb3JpZ2luLCBkZXN0aW5hdGlvbiwgdHJpcF9kYXRlLCBmYXJlLCB1bmlxdWkudHJpbVJpZ2h0KCksICdBY3RpdmUnXSxcbiAgfTtcblxuICBkYi5xdWVyeShxdWVyeSkudGhlbigocmVzcCkgPT4ge1xuICAgIGNvbnN0IHRyaXBfZGF0YSA9IHJlc3Aucm93c1swXTtcbiAgICB0cmlwX2RhdGEuaWQgPSByZXNwLnJvd3NbMF0uYm9va2luZ19pZDtcbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbihyZXNwb25zZS5zdWNjZXNzKHRyaXBfZGF0YSkpO1xuICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoZXJyKSk7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ1NvbWV0aGluZyB3ZW50IHdyb25nJykpO1xuICB9KTtcbn0pLmdldCgnLycsIChyZXEsIHJlcykgPT4ge1xuICAvLyBnZXQgYWxsIHRyaXBzIGF2YWlsYWJsZVxuICBkYi5xdWVyeShcIlNFTEVDVCAqIEZST00gdHJpcHMgV0hFUkUgc3RhdHVzID0gJ0FjdGl2ZScgXCIpLnRoZW4oKHJlc3ApID0+IHtcbiAgICByZXMuc3RhdHVzKDIwMCkuanNvbihyZXNwb25zZS5zdWNjZXNzKHJlc3Aucm93cykpO1xuICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgbG9nZ2VyLmVycm9yKGVycik7XG4gICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoZXJyKSk7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCB0cmlwcycpKTtcbiAgfSk7XG59KS5wYXRjaCgnLzp0cmlwSWQnLCBhdXRoQ2hlY2ssIChyZXEsIHJlcykgPT4ge1xuICAvLyBjYW5jZWwgYSB0cmlwXG4gIGNvbnN0IHRyaXBJZCA9IHJlcS5wYXJhbXMudHJpcElkO1xuICBjb25zdCB7IGRhdGEgfSA9IHJlcS5kZWNvZGVkO1xuICBpZiAoIWRhdGEuaXNfYWRtaW4pIHtcbiAgICByZXMuc3RhdHVzKDQwMSkuanNvbihyZXNwb25zZS5lcnJvcignQWNjZXNzIERlbmllZCcpKTtcbiAgfVxuXG4gIGRiLnF1ZXJ5KGBTRUxFQ1QgKiBGUk9NIHRyaXBzIFdIRVJFIHN0YXR1cyA9ICdBY3RpdmUnIEFORCB0cmlwX2lkID0gJyR7dHJpcElkfScgYCkudGhlbigocmVzcCkgPT4ge1xuICAgIGlmIChyZXNwLnJvd0NvdW50IDw9IDApIHtcbiAgICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHJlc3BvbnNlLmVycm9yKCdUcmlwIE5vdCBmb3VuZCcpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGIucXVlcnkoYFVQREFURSB0cmlwcyBTRVQgc3RhdHVzID0gJ2NhbmNlbGxlZCcgV0hFUkUgdHJpcF9pZCA9ICcke3RyaXBJZH0nIEFORCBzdGF0dXMgPSAnQWN0aXZlJ2ApLnRoZW4oKGJ1c0RhdGEpID0+IHtcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24ocmVzcG9uc2Uuc3VjY2Vzcyh7IG1lc3NhZ2U6ICdUcmlwIGNhbmNlbGxlZCBzdWNjZXNzZnVsbHknLCBidXNEYXRhIH0pKTtcbiAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoeyBtZXNzYWdlOiAnVHJpcCBmYWlsZWQgdG8gY2FuY2VsJyB9KSk7XG4gICAgICAgIGxvZ2dlci5lcnJvcih7IGVyciwgbWVzc2FnZTogJ3doaWxlIGNhbmNlbGluZyB0cmlwJyB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgIGxvZ2dlci5lcnJvcihlcnIpO1xuXG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCB0cmlwcycpKTtcbiAgfSk7XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSByb3V0ZXI7XG4iXX0=