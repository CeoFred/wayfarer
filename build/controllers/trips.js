"use strict";

var express = require('express');

var logger = require('logger').createLogger('./development.log');

var router = express.Router();

var response = require('../helpers/response');

var db = require('../config/db');

var Utils = require('../helpers/utils');

var authCheck = require('../middlewares/auth_check');

router.post('/', authCheck, function (req, res) {
  // new trip
  var _req$body = req.body,
      origin = _req$body.origin,
      destination = _req$body.destination,
      fare = _req$body.fare,
      trip_date = _req$body.trip_date;
  var data = req.decoded.data;
  console.log(data);

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  var uniqui = Utils.randomString(200);
  var query = {
    text: 'INSERT INTO trips(user_id,origin,destination,trip_date,fare,trip_id,status) VALUES($1,$2,$3,$4,$5,$6,$7) RETURNING *',
    values: [data.user_id, origin, destination, trip_date, fare, uniqui.trimRight(), 'Active']
  };
  db.query(query).then(function (resp) {
    var trip_data = resp.rows[0];
    trip_data.id = resp.rows[0].booking_id;
    res.status(201).json(response.success(trip_data));
  })["catch"](function (err) {
    logger.error(err);
    res.status(500).json(response.error('Something went wrong'));
  });
}).get('/', function (req, res) {
  // get all trips available
  db.query("SELECT * FROM trips WHERE status = 'Active' ").then(function (resp) {
    res.status(200).json(response.success(resp.rows));
  })["catch"](function (err) {
    logger.error(err);
    res.status(500).json(response.error('Failed to fetch trips'));
  });
}).patch('/:tripId', authCheck, function (req, res) {
  // cancel a trip
  var tripId = req.params.tripId;
  var data = req.decoded.data;

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  db.query("SELECT * FROM trips WHERE status = 'Active' AND trip_id = '".concat(tripId, "' ")).then(function (resp) {
    if (resp.rowCount <= 0) {
      res.status(404).json(response.error('Trip Not found'));
    } else {
      db.query("UPDATE trips SET status = 'cancelled' WHERE trip_id = '".concat(tripId, "' AND status = 'Active'")).then(function (busData) {
        res.status(200).json(response.success({
          message: 'Trip cancelled successfully',
          busData: busData
        }));
      })["catch"](function (err) {
        res.status(500).json(response.error({
          message: 'Trip failed to cancel'
        }));
        logger.error({
          err: err,
          message: 'while canceling trip'
        });
      });
    }
  })["catch"](function (err) {
    logger.error(err);
    res.status(500).json(response.error('Failed to fetch trips'));
  });
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2FwcC9jb250cm9sbGVycy90cmlwcy5qcyJdLCJuYW1lcyI6WyJleHByZXNzIiwicmVxdWlyZSIsImxvZ2dlciIsImNyZWF0ZUxvZ2dlciIsInJvdXRlciIsIlJvdXRlciIsInJlc3BvbnNlIiwiZGIiLCJVdGlscyIsImF1dGhDaGVjayIsInBvc3QiLCJyZXEiLCJyZXMiLCJib2R5Iiwib3JpZ2luIiwiZGVzdGluYXRpb24iLCJmYXJlIiwidHJpcF9kYXRlIiwiZGF0YSIsImRlY29kZWQiLCJjb25zb2xlIiwibG9nIiwiaXNfYWRtaW4iLCJzdGF0dXMiLCJqc29uIiwiZXJyb3IiLCJ1bmlxdWkiLCJyYW5kb21TdHJpbmciLCJxdWVyeSIsInRleHQiLCJ2YWx1ZXMiLCJ1c2VyX2lkIiwidHJpbVJpZ2h0IiwidGhlbiIsInJlc3AiLCJ0cmlwX2RhdGEiLCJyb3dzIiwiaWQiLCJib29raW5nX2lkIiwic3VjY2VzcyIsImVyciIsImdldCIsInBhdGNoIiwidHJpcElkIiwicGFyYW1zIiwicm93Q291bnQiLCJidXNEYXRhIiwibWVzc2FnZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxJQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxRQUFELENBQVAsQ0FBa0JFLFlBQWxCLENBQStCLG1CQUEvQixDQUFmOztBQUVBLElBQU1DLE1BQU0sR0FBR0osT0FBTyxDQUFDSyxNQUFSLEVBQWY7O0FBQ0EsSUFBTUMsUUFBUSxHQUFHTCxPQUFPLENBQUMscUJBQUQsQ0FBeEI7O0FBQ0EsSUFBTU0sRUFBRSxHQUFHTixPQUFPLENBQUMsY0FBRCxDQUFsQjs7QUFDQSxJQUFNTyxLQUFLLEdBQUdQLE9BQU8sQ0FBQyxrQkFBRCxDQUFyQjs7QUFFQSxJQUFNUSxTQUFTLEdBQUdSLE9BQU8sQ0FBQywyQkFBRCxDQUF6Qjs7QUFFQUcsTUFBTSxDQUFDTSxJQUFQLENB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V1MsVUFBQ1AsR0FBRCxFQUFTO0FBQ2hCdEMsSUFBQUEsTUFBTSxDQUFDdUIsS0FBUCxDQUFhZSxHQUFiO0FBRUE1QixJQUFBQSxHQUFHLENBQUNXLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQmxCLFFBQVEsQ0FBQ21CLEtBQVQsQ0FBZSx1QkFBZixDQUFyQjtBQUNELEdBZkQ7QUFnQkQsQ0FqRUQ7QUFtRUF1QixNQUFNLENBQUNDLE9BQVAsR0FBaUI3QyxNQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKCdsb2dnZXInKS5jcmVhdGVMb2dnZXIoJy4vZGV2ZWxvcG1lbnQubG9nJyk7XG5cbmNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5jb25zdCByZXNwb25zZSA9IHJlcXVpcmUoJy4uL2hlbHBlcnMvcmVzcG9uc2UnKTtcbmNvbnN0IGRiID0gcmVxdWlyZSgnLi4vY29uZmlnL2RiJyk7XG5jb25zdCBVdGlscyA9IHJlcXVpcmUoJy4uL2hlbHBlcnMvdXRpbHMnKTtcblxuY29uc3QgYXV0aENoZWNrID0gcmVxdWlyZSgnLi4vbWlkZGxld2FyZXMvYXV0aF9jaGVjaycpO1xuXG5yb3V0ZXIucG9zdCgnLycsIGF1dGhDaGVjaywgKHJlcSwgcmVzKSA9PiB7XG4gIC8vIG5ldyB0cmlwXG4gIGNvbnN0IHtcbiAgICBvcmlnaW4sXG4gICAgZGVzdGluYXRpb24sXG4gICAgZmFyZSxcbiAgICB0cmlwX2RhdGUsXG5cbiAgfSA9IHJlcS5ib2R5O1xuICBjb25zdCB7IGRhdGEgfSA9IHJlcS5kZWNvZGVkO1xuICBjb25zb2xlLmxvZyhkYXRhKTtcblxuICBpZiAoIWRhdGEuaXNfYWRtaW4pIHtcbiAgICByZXMuc3RhdHVzKDQwMSkuanNvbihyZXNwb25zZS5lcnJvcignQWNjZXNzIERlbmllZCcpKTtcbiAgfVxuXG4gIGNvbnN0IHVuaXF1aSA9IFV0aWxzLnJhbmRvbVN0cmluZygyMDApO1xuXG4gIGNvbnN0IHF1ZXJ5ID0ge1xuICAgIHRleHQ6ICdJTlNFUlQgSU5UTyB0cmlwcyh1c2VyX2lkLG9yaWdpbixkZXN0aW5hdGlvbix0cmlwX2RhdGUsZmFyZSx0cmlwX2lkLHN0YXR1cykgVkFMVUVTKCQxLCQyLCQzLCQ0LCQ1LCQ2LCQ3KSBSRVRVUk5JTkcgKicsXG4gICAgdmFsdWVzOiBbZGF0YS51c2VyX2lkLCBvcmlnaW4sIGRlc3RpbmF0aW9uLCB0cmlwX2RhdGUsIGZhcmUsIHVuaXF1aS50cmltUmlnaHQoKSwgJ0FjdGl2ZSddLFxuICB9O1xuXG4gIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKChyZXNwKSA9PiB7XG4gICAgY29uc3QgdHJpcF9kYXRhID0gcmVzcC5yb3dzWzBdO1xuICAgIHRyaXBfZGF0YS5pZCA9IHJlc3Aucm93c1swXS5ib29raW5nX2lkO1xuICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKHJlc3BvbnNlLnN1Y2Nlc3ModHJpcF9kYXRhKSk7XG4gIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICBsb2dnZXIuZXJyb3IoZXJyKTtcblxuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHJlc3BvbnNlLmVycm9yKCdTb21ldGhpbmcgd2VudCB3cm9uZycpKTtcbiAgfSk7XG59KS5nZXQoJy8nLCAocmVxLCByZXMpID0+IHtcbiAgLy8gZ2V0IGFsbCB0cmlwcyBhdmFpbGFibGVcbiAgZGIucXVlcnkoXCJTRUxFQ1QgKiBGUk9NIHRyaXBzIFdIRVJFIHN0YXR1cyA9ICdBY3RpdmUnIFwiKS50aGVuKChyZXNwKSA9PiB7XG4gICAgcmVzLnN0YXR1cygyMDApLmpzb24ocmVzcG9uc2Uuc3VjY2VzcyhyZXNwLnJvd3MpKTtcbiAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgIGxvZ2dlci5lcnJvcihlcnIpO1xuXG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCB0cmlwcycpKTtcbiAgfSk7XG59KS5wYXRjaCgnLzp0cmlwSWQnLCBhdXRoQ2hlY2ssIChyZXEsIHJlcykgPT4ge1xuICAvLyBjYW5jZWwgYSB0cmlwXG4gIGNvbnN0IHRyaXBJZCA9IHJlcS5wYXJhbXMudHJpcElkO1xuICBjb25zdCB7IGRhdGEgfSA9IHJlcS5kZWNvZGVkO1xuICBpZiAoIWRhdGEuaXNfYWRtaW4pIHtcbiAgICByZXMuc3RhdHVzKDQwMSkuanNvbihyZXNwb25zZS5lcnJvcignQWNjZXNzIERlbmllZCcpKTtcbiAgfVxuXG4gIGRiLnF1ZXJ5KGBTRUxFQ1QgKiBGUk9NIHRyaXBzIFdIRVJFIHN0YXR1cyA9ICdBY3RpdmUnIEFORCB0cmlwX2lkID0gJyR7dHJpcElkfScgYCkudGhlbigocmVzcCkgPT4ge1xuICAgIGlmIChyZXNwLnJvd0NvdW50IDw9IDApIHtcbiAgICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHJlc3BvbnNlLmVycm9yKCdUcmlwIE5vdCBmb3VuZCcpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGIucXVlcnkoYFVQREFURSB0cmlwcyBTRVQgc3RhdHVzID0gJ2NhbmNlbGxlZCcgV0hFUkUgdHJpcF9pZCA9ICcke3RyaXBJZH0nIEFORCBzdGF0dXMgPSAnQWN0aXZlJ2ApLnRoZW4oKGJ1c0RhdGEpID0+IHtcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24ocmVzcG9uc2Uuc3VjY2Vzcyh7IG1lc3NhZ2U6ICdUcmlwIGNhbmNlbGxlZCBzdWNjZXNzZnVsbHknLCBidXNEYXRhIH0pKTtcbiAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoeyBtZXNzYWdlOiAnVHJpcCBmYWlsZWQgdG8gY2FuY2VsJyB9KSk7XG4gICAgICAgIGxvZ2dlci5lcnJvcih7IGVyciwgbWVzc2FnZTogJ3doaWxlIGNhbmNlbGluZyB0cmlwJyB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgIGxvZ2dlci5lcnJvcihlcnIpO1xuXG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCB0cmlwcycpKTtcbiAgfSk7XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSByb3V0ZXI7XG4iXX0=