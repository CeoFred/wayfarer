"use strict";

var express = require('express');

var logger = require('logger').createLogger('./development.log');

var router = express.Router();

var response = require('../helpers/response');

var db = require('../config/db');

var Utils = require('../helpers/utils');

var authCheck = require('../middlewares/auth_check');

router.post('/', authCheck, function (req, res) {
  // new trip
  var _req$body = req.body,
      origin = _req$body.origin,
      destination = _req$body.destination,
      fare = _req$body.fare,
      trip_date = _req$body.trip_date;
  var data = req.decoded.data;

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  var uniqui = Utils.randomString(200);
  var query = {
    text: 'INSERT INTO trips(user_id,origin,destination,trip_date,fare,trip_id,status) VALUES($1,$2,$3,$4,$5,$6,$7) RETURNING *',
    values: [data.user_id, origin, destination, trip_date, fare, uniqui.trimRight(), 'Active']
  };
  db.query(query).then(function (resp) {
    var trip_data = resp.rows[0];
    trip_data.id = resp.rows[0].booking_id;
    res.status(201).json(response.success(trip_data));
  })["catch"](function (err) {
    logger.error(err);
    res.status(500).json(response.error('Something went wrong'));
  });
}).get('/', function (req, res) {
  // get all trips available
  db.query("SELECT * FROM trips WHERE status = 'Active' ").then(function (resp) {
    res.status(200).json(response.success(resp.rows));
  })["catch"](function (err) {
    logger.error(err);
    console.log(err);
    res.status(500).json(response.error('Failed to fetch trips'));
  });
}).patch('/:tripId', authCheck, function (req, res) {
  // cancel a trip
  var tripId = req.params.tripId;
  var data = req.decoded.data;

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  db.query("SELECT * FROM trips WHERE status = 'Active' AND trip_id = '".concat(tripId, "' ")).then(function (resp) {
    if (resp.rowCount <= 0) {
      res.status(404).json(response.error('Trip Not found'));
    } else {
      db.query("UPDATE trips SET status = 'cancelled' WHERE trip_id = '".concat(tripId, "' AND status = 'Active'")).then(function (busData) {
        res.status(200).json(response.success({
          message: 'Trip cancelled successfully',
          busData: busData
        }));
      })["catch"](function (err) {
        res.status(500).json(response.error({
          message: 'Trip failed to cancel'
        }));
        logger.error({
          err: err,
          message: 'while canceling trip'
        });
      });
    }
  })["catch"](function (err) {
    logger.error(err);
    res.status(500).json(response.error('Failed to fetch trips'));
  });
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2FwcC9jb250cm9sbGVycy90cmlwcy5qcyJdLCJuYW1lcyI6WyJleHByZXNzIiwicmVxdWlyZSIsImxvZ2dlciIsImNyZWF0ZUxvZ2dlciIsInJvdXRlciIsIlJvdXRlciIsInJlc3BvbnNlIiwiZGIiLCJVdGlscyIsImF1dGhDaGVjayIsInBvc3QiLCJyZXEiLCJyZXMiLCJib2R5Iiwib3JpZ2luIiwiZGVzdGluYXRpb24iLCJmYXJlIiwidHJpcF9kYXRlIiwiZGF0YSIsImRlY29kZWQiLCJpc19hZG1pbiIsInN0YXR1cyIsImpzb24iLCJlcnJvciIsInVuaXF1aSIsInJhbmRvbVN0cmluZyIsInF1ZXJ5IiwidGV4dCIsInZhbHVlcyIsInVzZXJfaWQiLCJ0cmltUmlnaHQiLCJ0aGVuIiwicmVzcCIsInRyaXBfZGF0YSIsInJvd3MiLCJpZCIsImJvb2tpbmdfaWQiLCJzdWNjZXNzIiwiZXJyIiwiZ2V0IiwiY29uc29sZSIsImxvZyIsInBhdGNoIiwidHJpcElkIiwicGFyYW1zIiwicm93Q291bnQiLCJidXNEYXRhIiwibWVzc2FnZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxJQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxRQUFELENBQVAsQ0FBa0JFLFlBQWxCLENBQStCLG1CQUEvQixDQUFmOztBQUVBLElBQU1DLE1BQU0sR0FBR0osT0FBTyxDQUFDSyxNQUFSLEVBQWY7O0FBQ0EsSUFBTUMsUUFBUSxHQUFHTCxPQUFPLENBQUMscUJBQUQsQ0FBeEI7O0FBQ0EsSUFBTU0sRUFBRSxHQUFHTixPQUFPLENBQUMsY0FBRCxDQUFsQjs7QUFDQSxJQUFNTyxLQUFLLEdBQUdQLE9BQU8sQ0FBQyxrQkFBRCxDQUFyQjs7QUFFQSxJQUFNUSxTQUFTLEdBQUdSLE9BQU8sQ0FBQywyQkFBRCxDQUF6Qjs7QUFFQUcsTUFBTSxDQUFDTSxJQUFQLENB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QVdTLFVBQUNULEdBQUQsRUFBUztBQUNoQnBDLElBQUFBLE1BQU0sQ0FBQ3FCLEtBQVAsQ0FBYWUsR0FBYjtBQUVBMUIsSUFBQUEsR0FBRyxDQUFDUyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJoQixRQUFRLENBQUNpQixLQUFULENBQWUsdUJBQWYsQ0FBckI7QUFDRCxHQWZEO0FBZ0JELENBOUREO0FBZ0VBeUIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCN0MsTUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xuY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnbG9nZ2VyJykuY3JlYXRlTG9nZ2VyKCcuL2RldmVsb3BtZW50LmxvZycpO1xuXG5jb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuY29uc3QgcmVzcG9uc2UgPSByZXF1aXJlKCcuLi9oZWxwZXJzL3Jlc3BvbnNlJyk7XG5jb25zdCBkYiA9IHJlcXVpcmUoJy4uL2NvbmZpZy9kYicpO1xuY29uc3QgVXRpbHMgPSByZXF1aXJlKCcuLi9oZWxwZXJzL3V0aWxzJyk7XG5cbmNvbnN0IGF1dGhDaGVjayA9IHJlcXVpcmUoJy4uL21pZGRsZXdhcmVzL2F1dGhfY2hlY2snKTtcblxucm91dGVyLnBvc3QoJy8nLCBhdXRoQ2hlY2ssIChyZXEsIHJlcykgPT4ge1xuICAvLyBuZXcgdHJpcFxuICBjb25zdCB7XG4gICAgb3JpZ2luLFxuICAgIGRlc3RpbmF0aW9uLFxuICAgIGZhcmUsXG4gICAgdHJpcF9kYXRlLFxuXG4gIH0gPSByZXEuYm9keTtcbiAgY29uc3QgeyBkYXRhIH0gPSByZXEuZGVjb2RlZDtcbiAgaWYgKCFkYXRhLmlzX2FkbWluKSB7XG4gICAgcmVzLnN0YXR1cyg0MDEpLmpzb24ocmVzcG9uc2UuZXJyb3IoJ0FjY2VzcyBEZW5pZWQnKSk7XG4gIH1cblxuICBjb25zdCB1bmlxdWkgPSBVdGlscy5yYW5kb21TdHJpbmcoMjAwKTtcblxuICBjb25zdCBxdWVyeSA9IHtcbiAgICB0ZXh0OiAnSU5TRVJUIElOVE8gdHJpcHModXNlcl9pZCxvcmlnaW4sZGVzdGluYXRpb24sdHJpcF9kYXRlLGZhcmUsdHJpcF9pZCxzdGF0dXMpIFZBTFVFUygkMSwkMiwkMywkNCwkNSwkNiwkNykgUkVUVVJOSU5HIConLFxuICAgIHZhbHVlczogW2RhdGEudXNlcl9pZCwgb3JpZ2luLCBkZXN0aW5hdGlvbiwgdHJpcF9kYXRlLCBmYXJlLCB1bmlxdWkudHJpbVJpZ2h0KCksICdBY3RpdmUnXSxcbiAgfTtcblxuICBkYi5xdWVyeShxdWVyeSkudGhlbigocmVzcCkgPT4ge1xuICAgIGNvbnN0IHRyaXBfZGF0YSA9IHJlc3Aucm93c1swXTtcbiAgICB0cmlwX2RhdGEuaWQgPSByZXNwLnJvd3NbMF0uYm9va2luZ19pZDtcbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbihyZXNwb25zZS5zdWNjZXNzKHRyaXBfZGF0YSkpO1xuICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgbG9nZ2VyLmVycm9yKGVycik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ1NvbWV0aGluZyB3ZW50IHdyb25nJykpO1xuICB9KTtcbn0pLmdldCgnLycsIChyZXEsIHJlcykgPT4ge1xuICAvLyBnZXQgYWxsIHRyaXBzIGF2YWlsYWJsZVxuICBkYi5xdWVyeShcIlNFTEVDVCAqIEZST00gdHJpcHMgV0hFUkUgc3RhdHVzID0gJ0FjdGl2ZScgXCIpLnRoZW4oKHJlc3ApID0+IHtcbiAgICByZXMuc3RhdHVzKDIwMCkuanNvbihyZXNwb25zZS5zdWNjZXNzKHJlc3Aucm93cykpO1xuICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgbG9nZ2VyLmVycm9yKGVycik7XG4gICAgY29uc29sZS5sb2coZXJyKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbihyZXNwb25zZS5lcnJvcignRmFpbGVkIHRvIGZldGNoIHRyaXBzJykpO1xuICB9KTtcbn0pLnBhdGNoKCcvOnRyaXBJZCcsIGF1dGhDaGVjaywgKHJlcSwgcmVzKSA9PiB7XG4gIC8vIGNhbmNlbCBhIHRyaXBcbiAgY29uc3QgdHJpcElkID0gcmVxLnBhcmFtcy50cmlwSWQ7XG4gIGNvbnN0IHsgZGF0YSB9ID0gcmVxLmRlY29kZWQ7XG4gIGlmICghZGF0YS5pc19hZG1pbikge1xuICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHJlc3BvbnNlLmVycm9yKCdBY2Nlc3MgRGVuaWVkJykpO1xuICB9XG5cbiAgZGIucXVlcnkoYFNFTEVDVCAqIEZST00gdHJpcHMgV0hFUkUgc3RhdHVzID0gJ0FjdGl2ZScgQU5EIHRyaXBfaWQgPSAnJHt0cmlwSWR9JyBgKS50aGVuKChyZXNwKSA9PiB7XG4gICAgaWYgKHJlc3Aucm93Q291bnQgPD0gMCkge1xuICAgICAgcmVzLnN0YXR1cyg0MDQpLmpzb24ocmVzcG9uc2UuZXJyb3IoJ1RyaXAgTm90IGZvdW5kJykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBkYi5xdWVyeShgVVBEQVRFIHRyaXBzIFNFVCBzdGF0dXMgPSAnY2FuY2VsbGVkJyBXSEVSRSB0cmlwX2lkID0gJyR7dHJpcElkfScgQU5EIHN0YXR1cyA9ICdBY3RpdmUnYCkudGhlbigoYnVzRGF0YSkgPT4ge1xuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbihyZXNwb25zZS5zdWNjZXNzKHsgbWVzc2FnZTogJ1RyaXAgY2FuY2VsbGVkIHN1Y2Nlc3NmdWxseScsIGJ1c0RhdGEgfSkpO1xuICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbihyZXNwb25zZS5lcnJvcih7IG1lc3NhZ2U6ICdUcmlwIGZhaWxlZCB0byBjYW5jZWwnIH0pKTtcbiAgICAgICAgbG9nZ2VyLmVycm9yKHsgZXJyLCBtZXNzYWdlOiAnd2hpbGUgY2FuY2VsaW5nIHRyaXAnIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgbG9nZ2VyLmVycm9yKGVycik7XG5cbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbihyZXNwb25zZS5lcnJvcignRmFpbGVkIHRvIGZldGNoIHRyaXBzJykpO1xuICB9KTtcbn0pO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHJvdXRlcjtcbiJdfQ==