"use strict";

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { if (i % 2) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } else { Object.defineProperties(target, Object.getOwnPropertyDescriptors(arguments[i])); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var express = require('express');

var logger = require('logger').createLogger('./development.log');

var router = express.Router();

var _require = require('express-validator'),
    check = _require.check,
    validationResult = _require.validationResult,
    body = _require.body;

var response = require('../helpers/response');

var db = require('../config/db');

var Utils = require('../helpers/utils');

var authCheck = require('../middlewares/auth_check');

router.post('/', authCheck, [check('origin').exists().withMessage('origin is required'), body('origin').not().isEmpty().escape(), check('destination').exists().withMessage('destination is required'), body('destination').not().isEmpty().escape(), check('fare').exists().withMessage('fare is required'), body('fare').not().isEmpty().escape(), check('trip_date').exists().withMessage('trip Date is required'), body('trip_date').not().isEmpty().escape()], function (req, res) {
  // new trip
  var errors = validationResult(req);

  if (!errors.isEmpty()) {
    res.status(403).json(response.error(errors));
  }

  var _req$body = req.body,
      origin = _req$body.origin,
      destination = _req$body.destination,
      fare = _req$body.fare,
      trip_date = _req$body.trip_date;
  var data = req.decoded.data;
  console.log(data);

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  var uniqui = Utils.randomString(200);
  var query = {
    text: 'INSERT INTO trips(user_id,origin,destination,trip_date,fare,trip_id,status) VALUES($1,$2,$3,$4,$5,$6,$7) RETURNING *',
    values: [data.user_id, origin, destination, trip_date, fare, uniqui, 'Active']
  };
  db.query(query).then(function (resp) {
    var trip_data = null;
    trip_data = _objectSpread({}, resp.rows[0], {
      id: resp.rows[0].trip_id
    });
    res.status(201).json(response.success(trip_data));
  })["catch"](function (err) {
    console.log(err);
    res.status(500).json(response.error('Something went wrong'));
  });
}).get('/', function (req, res) {
  // get all trips available
  db.query("SELECT * FROM trips WHERE status = 'Active' ").then(function (resp) {
    res.status(200).json(response.success(resp.rows));
  })["catch"](function (err) {
    logger.error(err);
    console.log(JSON.stringify(err));
    res.status(500).json(response.error('Failed to fetch trips'));
  });
}).patch('/:tripId', authCheck, function (req, res) {
  // cancel a trip
  var tripId = req.params.tripId;
  var data = req.decoded.data;

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  db.query("SELECT * FROM trips WHERE status = 'Active' AND trip_id = '".concat(tripId, "' ")).then(function (resp) {
    if (resp.rowCount <= 0) {
      res.status(404).json(response.error('Trip Not found'));
    } else {
      db.query("UPDATE trips SET status = 'cancelled' WHERE trip_id = '".concat(tripId, "' AND status = 'Active'")).then(function (busData) {
        res.status(200).json(response.success({
          message: 'Trip cancelled successfully',
          busData: busData
        }));
      })["catch"](function (err) {
        res.status(500).json(response.error({
          message: 'Trip failed to cancel'
        }));
        logger.error({
          err: err,
          message: 'while canceling trip'
        });
      });
    }
  })["catch"](function (err) {
    logger.error(err);
    res.status(500).json(response.error('Failed to fetch trips'));
  });
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2FwcC9jb250cm9sbGVycy90cmlwcy5qcyJdLCJuYW1lcyI6WyJleHByZXNzIiwicmVxdWlyZSIsImxvZ2dlciIsImNyZWF0ZUxvZ2dlciIsInJvdXRlciIsIlJvdXRlciIsImNoZWNrIiwidmFsaWRhdGlvblJlc3VsdCIsImJvZHkiLCJyZXNwb25zZSIsImRiIiwiVXRpbHMiLCJhdXRoQ2hlY2siLCJwb3N0IiwiZXhpc3RzIiwid2l0aE1lc3NhZ2UiLCJub3QiLCJpc0VtcHR5IiwiZXNjYXBlIiwicmVxIiwicmVzIiwiZXJyb3JzIiwic3RhdHVzIiwianNvbiIsImVycm9yIiwib3JpZ2luIiwiZGVzdGluYXRpb24iLCJmYXJlIiwidHJpcF9kYXRlIiwiZGF0YSIsImRlY29kZWQiLCJjb25zb2xlIiwibG9nIiwiaXNfYWRtaW4iLCJ1bmlxdWkiLCJyYW5kb21TdHJpbmciLCJxdWVyeSIsInRleHQiLCJ2YWx1ZXMiLCJ1c2VyX2lkIiwidGhlbiIsInJlc3AiLCJ0cmlwX2RhdGEiLCJyb3dzIiwiaWQiLCJ0cmlwX2lkIiwic3VjY2VzcyIsImVyciIsImdldCIsIkpTT04iLCJzdHJpbmdpZnkiLCJwYXRjaCIsInRyaXBJZCIsInBhcmFtcyIsInJvd0NvdW50IiwiYnVzRGF0YSIsIm1lc3NhZ2UiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxTQUFELENBQXZCOztBQUNBLElBQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLFFBQUQsQ0FBUCxDQUFrQkUsWUFBbEIsQ0FBK0IsbUJBQS9CLENBQWY7O0FBRUEsSUFBTUMsTUFBTSxHQUFHSixPQUFPLENBQUNLLE1BQVIsRUFBZjs7ZUFJSUosT0FBTyxDQUFDLG1CQUFELEM7SUFGVEssSyxZQUFBQSxLO0lBQ0FDLGdCLFlBQUFBLGdCO0lBQWtCQyxJLFlBQUFBLEk7O0FBRXBCLElBQU1DLFFBQVEsR0FBR1IsT0FBTyxDQUFDLHFC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LEVBQUhBLEdBQUY7QUFBT1MsVUFBQUEsT0FBTyxFQUFFO0FBQWhCLFNBQWI7QUFDRCxPQUxEO0FBTUQ7QUFDRixHQVhELFdBV1MsVUFBQ1QsR0FBRCxFQUFTO0FBQ2hCN0MsSUFBQUEsTUFBTSxDQUFDc0IsS0FBUCxDQUFhdUIsR0FBYjtBQUVBM0IsSUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJkLFFBQVEsQ0FBQ2UsS0FBVCxDQUFlLHVCQUFmLENBQXJCO0FBQ0QsR0FmRDtBQWdCRCxDQTlFRDtBQWdGQWlDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnRELE1BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJ2xvZ2dlcicpLmNyZWF0ZUxvZ2dlcignLi9kZXZlbG9wbWVudC5sb2cnKTtcblxuY29uc3Qgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcbmNvbnN0IHtcbiAgY2hlY2ssXG4gIHZhbGlkYXRpb25SZXN1bHQsIGJvZHksXG59ID0gcmVxdWlyZSgnZXhwcmVzcy12YWxpZGF0b3InKTtcbmNvbnN0IHJlc3BvbnNlID0gcmVxdWlyZSgnLi4vaGVscGVycy9yZXNwb25zZScpO1xuY29uc3QgZGIgPSByZXF1aXJlKCcuLi9jb25maWcvZGInKTtcbmNvbnN0IFV0aWxzID0gcmVxdWlyZSgnLi4vaGVscGVycy91dGlscycpO1xuXG5jb25zdCBhdXRoQ2hlY2sgPSByZXF1aXJlKCcuLi9taWRkbGV3YXJlcy9hdXRoX2NoZWNrJyk7XG5cbnJvdXRlci5wb3N0KCcvJywgYXV0aENoZWNrLCBbXG4gIGNoZWNrKCdvcmlnaW4nKS5leGlzdHMoKS53aXRoTWVzc2FnZSgnb3JpZ2luIGlzIHJlcXVpcmVkJyksXG4gIGJvZHkoJ29yaWdpbicpLm5vdCgpLmlzRW1wdHkoKS5lc2NhcGUoKSxcblxuICBjaGVjaygnZGVzdGluYXRpb24nKS5leGlzdHMoKS53aXRoTWVzc2FnZSgnZGVzdGluYXRpb24gaXMgcmVxdWlyZWQnKSxcbiAgYm9keSgnZGVzdGluYXRpb24nKS5ub3QoKS5pc0VtcHR5KCkuZXNjYXBlKCksXG4gIGNoZWNrKCdmYXJlJykuZXhpc3RzKCkud2l0aE1lc3NhZ2UoJ2ZhcmUgaXMgcmVxdWlyZWQnKSxcbiAgYm9keSgnZmFyZScpLm5vdCgpLmlzRW1wdHkoKS5lc2NhcGUoKSxcblxuICBjaGVjaygndHJpcF9kYXRlJykuZXhpc3RzKCkud2l0aE1lc3NhZ2UoJ3RyaXAgRGF0ZSBpcyByZXF1aXJlZCcpLFxuICBib2R5KCd0cmlwX2RhdGUnKS5ub3QoKS5pc0VtcHR5KCkuZXNjYXBlKCksXG5dLCAocmVxLCByZXMpID0+IHtcbiAgLy8gbmV3IHRyaXBcbiAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGlvblJlc3VsdChyZXEpO1xuICBpZiAoIWVycm9ycy5pc0VtcHR5KCkpIHtcbiAgICByZXMuc3RhdHVzKDQwMykuanNvbihyZXNwb25zZS5lcnJvcihlcnJvcnMpKTtcbiAgfVxuICBjb25zdCB7XG4gICAgb3JpZ2luLFxuICAgIGRlc3RpbmF0aW9uLFxuICAgIGZhcmUsXG4gICAgdHJpcF9kYXRlLFxuXG4gIH0gPSByZXEuYm9keTtcbiAgY29uc3QgeyBkYXRhIH0gPSByZXEuZGVjb2RlZDtcbiAgY29uc29sZS5sb2coZGF0YSk7XG4gIGlmICghZGF0YS5pc19hZG1pbikge1xuICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHJlc3BvbnNlLmVycm9yKCdBY2Nlc3MgRGVuaWVkJykpO1xuICB9XG5cbiAgY29uc3QgdW5pcXVpID0gVXRpbHMucmFuZG9tU3RyaW5nKDIwMCk7XG5cbiAgY29uc3QgcXVlcnkgPSB7XG4gICAgdGV4dDogJ0lOU0VSVCBJTlRPIHRyaXBzKHVzZXJfaWQsb3JpZ2luLGRlc3RpbmF0aW9uLHRyaXBfZGF0ZSxmYXJlLHRyaXBfaWQsc3RhdHVzKSBWQUxVRVMoJDEsJDIsJDMsJDQsJDUsJDYsJDcpIFJFVFVSTklORyAqJyxcbiAgICB2YWx1ZXM6IFtkYXRhLnVzZXJfaWQsIG9yaWdpbiwgZGVzdGluYXRpb24sIHRyaXBfZGF0ZSwgZmFyZSwgdW5pcXVpLCAnQWN0aXZlJ10sXG4gIH07XG5cbiAgZGIucXVlcnkocXVlcnkpLnRoZW4oKHJlc3ApID0+IHtcbiAgICBsZXQgdHJpcF9kYXRhID0gbnVsbDtcbiAgICB0cmlwX2RhdGEgPSB7IC4uLnJlc3Aucm93c1swXSwgaWQ6IHJlc3Aucm93c1swXS50cmlwX2lkIH07XG4gICAgcmVzLnN0YXR1cygyMDEpLmpzb24ocmVzcG9uc2Uuc3VjY2Vzcyh0cmlwX2RhdGEpKTtcbiAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ1NvbWV0aGluZyB3ZW50IHdyb25nJykpO1xuICB9KTtcbn0pLmdldCgnLycsIChyZXEsIHJlcykgPT4ge1xuICAvLyBnZXQgYWxsIHRyaXBzIGF2YWlsYWJsZVxuICBkYi5xdWVyeShcIlNFTEVDVCAqIEZST00gdHJpcHMgV0hFUkUgc3RhdHVzID0gJ0FjdGl2ZScgXCIpLnRoZW4oKHJlc3ApID0+IHtcbiAgICByZXMuc3RhdHVzKDIwMCkuanNvbihyZXNwb25zZS5zdWNjZXNzKHJlc3Aucm93cykpO1xuICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgbG9nZ2VyLmVycm9yKGVycik7XG4gICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoZXJyKSk7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCB0cmlwcycpKTtcbiAgfSk7XG59KS5wYXRjaCgnLzp0cmlwSWQnLCBhdXRoQ2hlY2ssIChyZXEsIHJlcykgPT4ge1xuICAvLyBjYW5jZWwgYSB0cmlwXG4gIGNvbnN0IHRyaXBJZCA9IHJlcS5wYXJhbXMudHJpcElkO1xuICBjb25zdCB7IGRhdGEgfSA9IHJlcS5kZWNvZGVkO1xuICBpZiAoIWRhdGEuaXNfYWRtaW4pIHtcbiAgICByZXMuc3RhdHVzKDQwMSkuanNvbihyZXNwb25zZS5lcnJvcignQWNjZXNzIERlbmllZCcpKTtcbiAgfVxuXG4gIGRiLnF1ZXJ5KGBTRUxFQ1QgKiBGUk9NIHRyaXBzIFdIRVJFIHN0YXR1cyA9ICdBY3RpdmUnIEFORCB0cmlwX2lkID0gJyR7dHJpcElkfScgYCkudGhlbigocmVzcCkgPT4ge1xuICAgIGlmIChyZXNwLnJvd0NvdW50IDw9IDApIHtcbiAgICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHJlc3BvbnNlLmVycm9yKCdUcmlwIE5vdCBmb3VuZCcpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGIucXVlcnkoYFVQREFURSB0cmlwcyBTRVQgc3RhdHVzID0gJ2NhbmNlbGxlZCcgV0hFUkUgdHJpcF9pZCA9ICcke3RyaXBJZH0nIEFORCBzdGF0dXMgPSAnQWN0aXZlJ2ApLnRoZW4oKGJ1c0RhdGEpID0+IHtcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24ocmVzcG9uc2Uuc3VjY2Vzcyh7IG1lc3NhZ2U6ICdUcmlwIGNhbmNlbGxlZCBzdWNjZXNzZnVsbHknLCBidXNEYXRhIH0pKTtcbiAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoeyBtZXNzYWdlOiAnVHJpcCBmYWlsZWQgdG8gY2FuY2VsJyB9KSk7XG4gICAgICAgIGxvZ2dlci5lcnJvcih7IGVyciwgbWVzc2FnZTogJ3doaWxlIGNhbmNlbGluZyB0cmlwJyB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgIGxvZ2dlci5lcnJvcihlcnIpO1xuXG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCB0cmlwcycpKTtcbiAgfSk7XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSByb3V0ZXI7XG4iXX0=