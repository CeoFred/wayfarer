"use strict";

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { keys.push.apply(keys, Object.getOwnPropertySymbols(object)); } if (enumerableOnly) keys = keys.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var express = require('express');

var logger = require('logger').createLogger('./development.log');

var router = express.Router();

var _require = require('express-validator'),
    check = _require.check,
    validationResult = _require.validationResult,
    body = _require.body;

var response = require('../helpers/response');

var db = require('../config/db');

var Utils = require('../helpers/utils');

var authCheck = require('../middlewares/auth_check');

router.post('/', authCheck, [check('origin').exists().withMessage('origin is required'), body('origin').not().isEmpty().escape(), check('destination').exists().withMessage('destination is required'), body('destination').not().isEmpty().escape(), check('fare').exists().withMessage('fare is required'), body('fare').not().isEmpty().escape(), check('trip_date').exists().withMessage('trip Date is required'), body('trip_date').not().isEmpty().escape()], function (req, res) {
  // new trip
  var errors = validationResult(req);

  if (!errors.isEmpty()) {
    res.status(403).json(response.error(errors));
  }

  var _req$body = req.body,
      origin = _req$body.origin,
      destination = _req$body.destination,
      fare = _req$body.fare,
      trip_date = _req$body.trip_date;
  var data = req.decoded.data;
  console.log(data);

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  var busId = 'axp3OrMLni6kWX3UNmmvcwOOyqqK6QhgObaQmR0Nl0ssAk8gTDVOR8Q0EnboUwkLi58S7Kyygd9079BKYNEO9LOvtNVj6oOcwDNYP5CMcDiMuTQzkFM9PDzsXzh90n6ZUZgDOyfVpEkGNRVWj5Y887Wy4VbxmuYSeGhwJtkjRhtd6JLxVvfjlDxbVz36pbbHXRqlrnOk';
  var uniqui = Utils.randomString(200);
  var query = {
    text: 'INSERT INTO trips(bus_id,user_id,origin,destination,trip_date,fare,trip_id,status) VALUES($1,$2,$3,$4,$5,$6,$7,$8) RETURNING *',
    values: [busId, data.user_id, origin, destination, trip_date, fare, uniqui, 'Active']
  };
  db.query(query).then(function (resp) {
    var trip_data = null;
    trip_data = _objectSpread({}, resp.rows[0], {
      id: resp.rows[0].trip_id
    });
    res.status(201).json(response.success(trip_data));
  })["catch"](function (err) {
    console.log(err);
    res.status(500).json(response.error('Something went wrong'));
  });
}).get('/', function (req, res) {
  // get all trips available
  db.query("SELECT * FROM trips WHERE status = 'Active' ").then(function (resp) {
    res.status(200).json(response.success(resp.rows));
  })["catch"](function (err) {
    logger.error(err);
    console.log(JSON.stringify(err));
    res.status(500).json(response.error('Failed to fetch trips'));
  });
}).patch('/:tripId', authCheck, function (req, res) {
  // cancel a trip
  var tripId = req.params.tripId;
  var data = req.decoded.data;

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  db.query("SELECT * FROM trips WHERE status = 'Active' AND trip_id = '".concat(tripId, "' ")).then(function (resp) {
    if (resp.rowCount <= 0) {
      res.status(404).json(response.error('Trip Not found'));
    } else {
      db.query("UPDATE trips SET status = 'cancelled' WHERE trip_id = '".concat(tripId, "' AND status = 'Active'")).then(function (busData) {
        res.status(200).json(response.success({
          message: 'Trip cancelled successfully',
          busData: busData
        }));
      })["catch"](function (err) {
        logger.error({
          err: err,
          message: 'while canceling trip'
        });
        return res.status(500).json(response.error({
          message: 'Trip failed to cancel'
        }));
      });
    }
  })["catch"](function (err) {
    logger.error(err);
    return res.status(500).json(response.error('Failed to fetch trips'));
  });
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2FwcC9jb250cm9sbGVycy90cmlwcy5qcyJdLCJuYW1lcyI6WyJleHByZXNzIiwicmVxdWlyZSIsImxvZ2dlciIsImNyZWF0ZUxvZ2dlciIsInJvdXRlciIsIlJvdXRlciIsImNoZWNrIiwidmFsaWRhdGlvblJlc3VsdCIsImJvZHkiLCJyZXNwb25zZSIsImRiIiwiVXRpbHMiLCJhdXRoQ2hlY2siLCJwb3N0IiwiZXhpc3RzIiwid2l0aE1lc3NhZ2UiLCJub3QiLCJpc0VtcHR5IiwiZXNjYXBlIiwicmVxIiwicmVzIiwiZXJyb3JzIiwic3RhdHVzIiwianNvbiIsImVycm9yIiwib3JpZ2luIiwiZGVzdGluYXRpb24iLCJmYXJlIiwidHJpcF9kYXRlIiwiZGF0YSIsImRlY29kZWQiLCJjb25zb2xlIiwibG9nIiwiaXNfYWRtaW4iLCJidXNJZCIsInVuaXF1aSIsInJhbmRvbVN0cmluZyIsInF1ZXJ5IiwidGV4dCIsInZhbHVlcyIsInVzZXJfaWQiLCJ0aGVuIiwicmVzcCIsInRyaXBfZGF0YSIsInJvd3MiLCJpZCIsInRyaXBfaWQiLCJzdWNjZXNzIiwiZXJyIiwiZ2V0IiwiSlNPTiIsInN0cmluZ2lmeSIsInBhdGNoIiwidHJpcElkIiwicGFyYW1zIiwicm93Q291bnQiLCJidXNEYXRhIiwibWVzc2FnZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsSUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxJQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxRQUFELENBQVAsQ0FBa0JFLFlBQWxCLENBQStCLG1CQUEvQixDQUFmOztBQUVBLElBQU1DLE1BQU0sR0FBR0osT0FBTyxDQUFDSyxNQUFSLEVBQWY7O2VBSUlKLE9BQU8sQ0FBQyxtQkFBRCxDO0lBRlRLLEssWUFBQUEsSztJQUNBQyxnQixZQUFBQSxnQjtJQUFrQkMsSSxZQUFBQSxJOztBQUVwQixJQUFNQyxRQUFRLEdBQUdSLE9BQU8sQ0FBQyxxQkFBRCxDQUF4Qjs7QUFDQSxJQUFNUyxFQUFFLEdBQUdULE9BQU8sQ0FBQyxjQUFELENBQWxCOztBQUNBLElBQU1VLEtBQUssR0FBR1YsT0FBTyxDQUFDLGtCQUFELENBQXJCOztBQUVBLElBQU1XLFNBQVMsR0FBR1gsT0FBTyxDQUFDLDJCQUFELENBQXpCOztBQUVBRyxNQUFNLENBQUNTLElBQVAsQ0FBWSxHQUFaLEVBQWlCRCxTQUFqQixFQUE0QixDQUMxQk4sS0FBSyxDQUFDLFFBQUQsQ0FBTCxDQUFnQlEsTUFBaEIsR0FBeUJDLFdBQXpCLENBQXFDLG9CQUFyQyxDQUQwQixFQUUxQlAsSUFBSSxDQUFDLFFBQUQsQ0FBSixDQUFlUSxHQUFmLEdBQXFCQyxPQUFyQixHQUErQkMsTUFBL0IsRUFGMEIsRUFJMUJaLEtBQUssQ0FBQyxhQUFELENBQUwsQ0FBcUJRLE1BQXJCLEdBQThCQyxXQUE5QixDQUEwQyx5QkFBMUMsQ0FKMEIsRUFLMUJQLElBQUksQ0FBQyxhQUFELENBQUosQ0FBb0JRLEdBQXBCLEdBQTBCQyxPQUExQixHQUFvQ0MsTUFBcEMsRUFMMEIsRUFNMUJaLEtBQUssQ0FBQyxNQUFELENBQUwsQ0FBY1EsTUFBZCxHQUF1QkMsV0FBdkIsQ0FBbUMsa0JBQW5DLENBTjBCLEVBTzFCUCxJQUFJLENBQUMsTUFBRCxDQUFKLENBQWFRLEdBQWIsR0FBbUJDLE9BQW5CLEdBQTZCQyxNQUE3QixFQVAwQixFQVMxQlosS0FBSyxDQUFDLFdBQUQsQ0FBTCxDQUFtQlEsTUFBbkIsR0FBNEJDLFdBQTVCLENBQXdDLHVCQUF4QyxDQVQwQixFQVUxQlAsSUFBSSxDQUFDLFdBQUQsQ0FBSixDQUFrQlEsR0FBbEIsR0FBd0JDLE9BQXhCLEdBQWtDQyxNQUFsQyxFQVYwQixDQUE1QixFQVdHLFVBQUNDLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQ2Y7QUFDQSxNQUFNQyxNQUFNLEdBQUdkLGdCQUFnQixDQUFDWSxHQUFELENBQS9COztBQUNBLE1BQUksQ0FBQ0UsTUFBTSxDQUFDSixPQUFQLEVBQUwsRUFBdUI7QUFDckJHLElBQUFBLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCZCxRQUFRLENBQUNlLEtBQVQsQ0FBZUgsTUFBZixDQUFyQjtBQUNEOztBQUxjLGtCQVlYRixHQUFHLENBQUNYLElBWk87QUFBQSxNQU9iaUIsTUFQYSxhQU9iQSxNQVBhO0FBQUEsTUFRYkMsV0FSYSxhQVFiQSxXQVJhO0FBQUEsTUFTYkMsSUFUYSxhQVNiQSxJQVRhO0FBQUEsTUFVYkMsU0FWYSxhQVViQSxTQVZhO0FBQUEsTUFhUEMsSUFiTyxHQWFFVixHQUFHLENBQUNXLE9BYk4sQ0FhUEQsSUFiTztBQWNmRSxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUgsSUFBWjs7QUFDQSxNQUFJLENBQUNBLElBQUksQ0FBQ0ksUUFBVixFQUFvQjtBQUNsQmIsSUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJkLFFBQVEsQ0FBQ2UsS0FBVCxDQUFlLGVBQWYsQ0FBckI7QUFDRDs7QUFDRCxNQUFNVSxLQUFLLEdBQUcsME1BQWQ7QUFDQSxNQUFNQyxNQUFNLEdBQUd4QixLQUFLLENBQUN5QixZQUFOLENBQW1CLEdBQW5CLENBQWY7QUFFQSxNQUFNQyxLQUFLLEdBQUc7QUFDWkMsSUFBQUEsSUFBSSxFQUFFLGdJQURNO0FBRVpDLElBQUFBLE1BQU0sRUFBRSxDQUFDTCxLQUFELEVBQVFMLElBQUksQ0FBQ1csT0FBYixFQUFzQmYsTUFBdEIsRUFBOEJDLFdBQTlCLEVBQTJDRSxTQUEzQyxFQUFzREQsSUFBdEQsRUFBNERRLE1BQTVELEVBQW9FLFFBQXBFO0FBRkksR0FBZDtBQUtBekIsRUFBQUEsRUFBRSxDQUFDMkIsS0FBSCxDQUFTQSxLQUFULEVBQWdCSSxJQUFoQixDQUFxQixVQUFDQyxJQUFELEVBQVU7QUFDN0IsUUFBSUMsU0FBUyxHQUFHLElBQWhCO0FBQ0FBLElBQUFBLFNBQVMscUJBQVFELElBQUksQ0FBQ0UsSUFBTCxDQUFVLENBQVYsQ0FBUjtBQUFzQkMsTUFBQUEsRUFBRSxFQUFFSCxJQUFJLENBQUNFLElBQUwsQ0FBVSxDQUFWLEVBQWFFO0FBQXZDLE1BQVQ7QUFDQTFCLElBQUFBLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCZCxRQUFRLENBQUNzQyxPQUFULENBQWlCSixTQUFqQixDQUFyQjtBQUNELEdBSkQsV0FJUyxVQUFDSyxHQUFELEVBQVM7QUFDaEJqQixJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWWdCLEdBQVo7QUFDQTVCLElBQUFBLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCZCxRQUFRLENBQUNlLEtBQVQsQ0FBZSxzQkFBZixDQUFyQjtBQUNELEdBUEQ7QUFRRCxDQTdDRCxFQTZDR3lCLEdBN0NILENBNkNPLEdBN0NQLEVBNkNZLFVBQUM5QixHQUFELEVBQU1DLEdBQU4sRUFBYztBQUN4QjtBQUNBVixFQUFBQSxFQUFFLENBQUMyQixLQUFILENBQVMsOENBQVQsRUFBeURJLElBQXpELENBQThELFVBQUNDLElBQUQsRUFBVTtBQUN0RXRCLElBQUFBLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCZCxRQUFRLENBQUNzQyxPQUFULENBQWlCTCxJQUFJLENBQUNFLElBQXRCLENBQXJCO0FBQ0QsR0FGRCxXQUVTLFVBQUNJLEdBQUQsRUFBUztBQUNoQjlDLElBQUFBLE1BQU0sQ0FBQ3NCLEtBQVAsQ0FBYXdCLEdBQWI7QUFDQWpCLElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZa0IsSUFBSSxDQUFDQyxTQUFMLENBQWVILEdBQWYsQ0FBWjtBQUNBNUIsSUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJkLFFBQVEsQ0FBQ2UsS0FBVCxDQUFlLHVCQUFmLENBQXJCO0FBQ0QsR0FORDtBQU9ELENBdERELEVBc0RHNEIsS0F0REgsQ0FzRFMsVUF0RFQsRUFzRHFCeEMsU0F0RHJCLEVBc0RnQyxVQUFDTyxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUM1QztBQUNBLE1BQU1pQyxNQUFNLEdBQUdsQyxHQUFHLENBQUNtQyxNQUFKLENBQVdELE1BQTFCO0FBRjRDLE1BR3BDeEIsSUFIb0MsR0FHM0JWLEdBQUcsQ0FBQ1csT0FIdUIsQ0FHcENELElBSG9DOztBQUk1QyxNQUFJLENBQUNBLElBQUksQ0FBQ0ksUUFBVixFQUFvQjtBQUNsQmIsSUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJkLFFBQVEsQ0FBQ2UsS0FBVCxDQUFlLGVBQWYsQ0FBckI7QUFDRDs7QUFFRGQsRUFBQUEsRUFBRSxDQUFDMkIsS0FBSCxzRUFBdUVnQixNQUF2RSxTQUFtRlosSUFBbkYsQ0FBd0YsVUFBQ0MsSUFBRCxFQUFVO0FBQ2hHLFFBQUlBLElBQUksQ0FBQ2EsUUFBTCxJQUFpQixDQUFyQixFQUF3QjtBQUN0Qm5DLE1BQUFBLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCZCxRQUFRLENBQUNlLEtBQVQsQ0FBZSxnQkFBZixDQUFyQjtBQUNELEtBRkQsTUFFTztBQUNMZCxNQUFBQSxFQUFFLENBQUMyQixLQUFILGtFQUFtRWdCLE1BQW5FLDhCQUFvR1osSUFBcEcsQ0FBeUcsVUFBQ2UsT0FBRCxFQUFhO0FBQ3BIcEMsUUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJkLFFBQVEsQ0FBQ3NDLE9BQVQsQ0FBaUI7QUFBRVUsVUFBQUEsT0FBTyxFQUFFLDZCQUFYO0FBQTBDRCxVQUFBQSxPQUFPLEVBQVBBO0FBQTFDLFNBQWpCLENBQXJCO0FBQ0QsT0FGRCxXQUVTLFVBQUNSLEdBQUQsRUFBUztBQUNoQjlDLFFBQUFBLE1BQU0sQ0FBQ3NCLEtBQVAsQ0FBYTtBQUFFd0IsVUFBQUEsR0FBRyxFQUFIQSxHQUFGO0FBQU9TLFVBQUFBLE9BQU8sRUFBRTtBQUFoQixTQUFiO0FBQ0EsZUFBT3JDLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCZCxRQUFRLENBQUNlLEtBQVQsQ0FBZTtBQUFFaUMsVUFBQUEsT0FBTyxFQUFFO0FBQVgsU0FBZixDQUFyQixDQUFQO0FBQ0QsT0FMRDtBQU1EO0FBQ0YsR0FYRCxXQVdTLFVBQUNULEdBQUQsRUFBUztBQUNoQjlDLElBQUFBLE1BQU0sQ0FBQ3NCLEtBQVAsQ0FBYXdCLEdBQWI7QUFDQSxXQUFPNUIsR0FBRyxDQUFDRSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUJkLFFBQVEsQ0FBQ2UsS0FBVCxDQUFlLHVCQUFmLENBQXJCLENBQVA7QUFDRCxHQWREO0FBZUQsQ0E3RUQ7QUErRUFrQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ2RCxNQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKCdsb2dnZXInKS5jcmVhdGVMb2dnZXIoJy4vZGV2ZWxvcG1lbnQubG9nJyk7XG5cbmNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5jb25zdCB7XG4gIGNoZWNrLFxuICB2YWxpZGF0aW9uUmVzdWx0LCBib2R5LFxufSA9IHJlcXVpcmUoJ2V4cHJlc3MtdmFsaWRhdG9yJyk7XG5jb25zdCByZXNwb25zZSA9IHJlcXVpcmUoJy4uL2hlbHBlcnMvcmVzcG9uc2UnKTtcbmNvbnN0IGRiID0gcmVxdWlyZSgnLi4vY29uZmlnL2RiJyk7XG5jb25zdCBVdGlscyA9IHJlcXVpcmUoJy4uL2hlbHBlcnMvdXRpbHMnKTtcblxuY29uc3QgYXV0aENoZWNrID0gcmVxdWlyZSgnLi4vbWlkZGxld2FyZXMvYXV0aF9jaGVjaycpO1xuXG5yb3V0ZXIucG9zdCgnLycsIGF1dGhDaGVjaywgW1xuICBjaGVjaygnb3JpZ2luJykuZXhpc3RzKCkud2l0aE1lc3NhZ2UoJ29yaWdpbiBpcyByZXF1aXJlZCcpLFxuICBib2R5KCdvcmlnaW4nKS5ub3QoKS5pc0VtcHR5KCkuZXNjYXBlKCksXG5cbiAgY2hlY2soJ2Rlc3RpbmF0aW9uJykuZXhpc3RzKCkud2l0aE1lc3NhZ2UoJ2Rlc3RpbmF0aW9uIGlzIHJlcXVpcmVkJyksXG4gIGJvZHkoJ2Rlc3RpbmF0aW9uJykubm90KCkuaXNFbXB0eSgpLmVzY2FwZSgpLFxuICBjaGVjaygnZmFyZScpLmV4aXN0cygpLndpdGhNZXNzYWdlKCdmYXJlIGlzIHJlcXVpcmVkJyksXG4gIGJvZHkoJ2ZhcmUnKS5ub3QoKS5pc0VtcHR5KCkuZXNjYXBlKCksXG5cbiAgY2hlY2soJ3RyaXBfZGF0ZScpLmV4aXN0cygpLndpdGhNZXNzYWdlKCd0cmlwIERhdGUgaXMgcmVxdWlyZWQnKSxcbiAgYm9keSgndHJpcF9kYXRlJykubm90KCkuaXNFbXB0eSgpLmVzY2FwZSgpLFxuXSwgKHJlcSwgcmVzKSA9PiB7XG4gIC8vIG5ldyB0cmlwXG4gIGNvbnN0IGVycm9ycyA9IHZhbGlkYXRpb25SZXN1bHQocmVxKTtcbiAgaWYgKCFlcnJvcnMuaXNFbXB0eSgpKSB7XG4gICAgcmVzLnN0YXR1cyg0MDMpLmpzb24ocmVzcG9uc2UuZXJyb3IoZXJyb3JzKSk7XG4gIH1cbiAgY29uc3Qge1xuICAgIG9yaWdpbixcbiAgICBkZXN0aW5hdGlvbixcbiAgICBmYXJlLFxuICAgIHRyaXBfZGF0ZSxcblxuICB9ID0gcmVxLmJvZHk7XG4gIGNvbnN0IHsgZGF0YSB9ID0gcmVxLmRlY29kZWQ7XG4gIGNvbnNvbGUubG9nKGRhdGEpO1xuICBpZiAoIWRhdGEuaXNfYWRtaW4pIHtcbiAgICByZXMuc3RhdHVzKDQwMSkuanNvbihyZXNwb25zZS5lcnJvcignQWNjZXNzIERlbmllZCcpKTtcbiAgfVxuICBjb25zdCBidXNJZCA9ICdheHAzT3JNTG5pNmtXWDNVTm1tdmN3T095cXFLNlFoZ09iYVFtUjBObDBzc0FrOGdURFZPUjhRMEVuYm9Vd2tMaTU4UzdLeXlnZDkwNzlCS1lORU85TE92dE5WajZvT2N3RE5ZUDVDTWNEaU11VFF6a0ZNOVBEenNYemg5MG42WlVaZ0RPeWZWcEVrR05SVldqNVk4ODdXeTRWYnhtdVlTZUdod0p0a2pSaHRkNkpMeFZ2ZmpsRHhiVnozNnBiYkhYUnFscm5Payc7XG4gIGNvbnN0IHVuaXF1aSA9IFV0aWxzLnJhbmRvbVN0cmluZygyMDApO1xuXG4gIGNvbnN0IHF1ZXJ5ID0ge1xuICAgIHRleHQ6ICdJTlNFUlQgSU5UTyB0cmlwcyhidXNfaWQsdXNlcl9pZCxvcmlnaW4sZGVzdGluYXRpb24sdHJpcF9kYXRlLGZhcmUsdHJpcF9pZCxzdGF0dXMpIFZBTFVFUygkMSwkMiwkMywkNCwkNSwkNiwkNywkOCkgUkVUVVJOSU5HIConLFxuICAgIHZhbHVlczogW2J1c0lkLCBkYXRhLnVzZXJfaWQsIG9yaWdpbiwgZGVzdGluYXRpb24sIHRyaXBfZGF0ZSwgZmFyZSwgdW5pcXVpLCAnQWN0aXZlJ10sXG4gIH07XG5cbiAgZGIucXVlcnkocXVlcnkpLnRoZW4oKHJlc3ApID0+IHtcbiAgICBsZXQgdHJpcF9kYXRhID0gbnVsbDtcbiAgICB0cmlwX2RhdGEgPSB7IC4uLnJlc3Aucm93c1swXSwgaWQ6IHJlc3Aucm93c1swXS50cmlwX2lkIH07XG4gICAgcmVzLnN0YXR1cygyMDEpLmpzb24ocmVzcG9uc2Uuc3VjY2Vzcyh0cmlwX2RhdGEpKTtcbiAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ1NvbWV0aGluZyB3ZW50IHdyb25nJykpO1xuICB9KTtcbn0pLmdldCgnLycsIChyZXEsIHJlcykgPT4ge1xuICAvLyBnZXQgYWxsIHRyaXBzIGF2YWlsYWJsZVxuICBkYi5xdWVyeShcIlNFTEVDVCAqIEZST00gdHJpcHMgV0hFUkUgc3RhdHVzID0gJ0FjdGl2ZScgXCIpLnRoZW4oKHJlc3ApID0+IHtcbiAgICByZXMuc3RhdHVzKDIwMCkuanNvbihyZXNwb25zZS5zdWNjZXNzKHJlc3Aucm93cykpO1xuICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgbG9nZ2VyLmVycm9yKGVycik7XG4gICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoZXJyKSk7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCB0cmlwcycpKTtcbiAgfSk7XG59KS5wYXRjaCgnLzp0cmlwSWQnLCBhdXRoQ2hlY2ssIChyZXEsIHJlcykgPT4ge1xuICAvLyBjYW5jZWwgYSB0cmlwXG4gIGNvbnN0IHRyaXBJZCA9IHJlcS5wYXJhbXMudHJpcElkO1xuICBjb25zdCB7IGRhdGEgfSA9IHJlcS5kZWNvZGVkO1xuICBpZiAoIWRhdGEuaXNfYWRtaW4pIHtcbiAgICByZXMuc3RhdHVzKDQwMSkuanNvbihyZXNwb25zZS5lcnJvcignQWNjZXNzIERlbmllZCcpKTtcbiAgfVxuXG4gIGRiLnF1ZXJ5KGBTRUxFQ1QgKiBGUk9NIHRyaXBzIFdIRVJFIHN0YXR1cyA9ICdBY3RpdmUnIEFORCB0cmlwX2lkID0gJyR7dHJpcElkfScgYCkudGhlbigocmVzcCkgPT4ge1xuICAgIGlmIChyZXNwLnJvd0NvdW50IDw9IDApIHtcbiAgICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHJlc3BvbnNlLmVycm9yKCdUcmlwIE5vdCBmb3VuZCcpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGIucXVlcnkoYFVQREFURSB0cmlwcyBTRVQgc3RhdHVzID0gJ2NhbmNlbGxlZCcgV0hFUkUgdHJpcF9pZCA9ICcke3RyaXBJZH0nIEFORCBzdGF0dXMgPSAnQWN0aXZlJ2ApLnRoZW4oKGJ1c0RhdGEpID0+IHtcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24ocmVzcG9uc2Uuc3VjY2Vzcyh7IG1lc3NhZ2U6ICdUcmlwIGNhbmNlbGxlZCBzdWNjZXNzZnVsbHknLCBidXNEYXRhIH0pKTtcbiAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKHsgZXJyLCBtZXNzYWdlOiAnd2hpbGUgY2FuY2VsaW5nIHRyaXAnIH0pO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoeyBtZXNzYWdlOiAnVHJpcCBmYWlsZWQgdG8gY2FuY2VsJyB9KSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICBsb2dnZXIuZXJyb3IoZXJyKTtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCB0cmlwcycpKTtcbiAgfSk7XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSByb3V0ZXI7XG4iXX0=