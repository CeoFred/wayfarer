"use strict";

var express = require('express');

var logger = require('logger').createLogger('./development.log');

var router = express.Router();

var response = require('../helpers/response');

var db = require('../config/db');

var Utils = require('../helpers/utils');

var authCheck = require('../middlewares/auth_check');

router.post('/', authCheck, function (req, res) {
  // new trip
  var _req$body = req.body,
      busId = _req$body.busId,
      origin = _req$body.origin,
      destination = _req$body.destination,
      fare = _req$body.fare,
      tripDate = _req$body.tripDate,
      departureTime = _req$body.departureTime;
  var data = req.decoded.data;
  console.log(data);

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  var uniqui = Utils.randomString(200);
  db.query("SELECT * FROM bus WHERE bus_id = '".concat(busId, "'")).then(function (busData) {
    if (busData.rowCount <= 0) {
      res.status(404).json(response.error('Bus not found'));
    } else if (Boolean(busData.rows[0].trip_status) === true) {
      res.status(403).json(response.error('Bus has a trip that is active'));
    } else {
      var query = {
        text: 'INSERT INTO trips(user_id,bus_id,origin,destination,trip_date,fare,departure_time,trip_id,status) VALUES($1,$2,$3,$4,$5,$6,$7,$8,$9) RETURNING *',
        values: [data.userId, busId, origin, destination, tripDate, fare, departureTime, uniqui.trimRight(), 'Active']
      };
      db.query(query).then(function (resp) {
        db.query("UPDATE bus SET trip_status = '".concat(true, "' WHERE bus_id = '", busId, "' RETURNING *")).then(function () {
          res.status(201).json(response.success(resp.rows[0]));
        })["catch"](function (err) {
          logger.error(err);
          res.status(500).json(response.error('Something went wrong'));
        });
      })["catch"](function (err) {
        logger.error(err);
        res.status(500).json(response.error('Something went wrong'));
      });
    }
  })["catch"](function (err) {
    logger.error(err);
    res.status(500).json(response.error('Whoops! Something went wrong'));
  });
}).get('/', function (req, res) {
  // get all trips available
  db.query("SELECT * FROM trips WHERE status = 'Active' ").then(function (resp) {
    res.status(200).json(response.success(resp.rows));
  })["catch"](function (err) {
    logger.error(err);
    res.status(500).json(response.error('Failed to fetch trips'));
  });
}).patch('/:tripId', authCheck, function (req, res) {
  // cancel a trip
  var tripId = req.params.tripId;
  var data = req.decoded.data;

  if (!data.is_admin) {
    res.status(401).json(response.error('Access Denied'));
  }

  db.query("SELECT * FROM trips WHERE status = 'Active' AND trip_id = '".concat(tripId, "' ")).then(function (resp) {
    if (resp.rowCount <= 0) {
      res.status(404).json(response.error('Trip Not found'));
    } else {
      db.query("UPDATE trips SET status = 'cancelled' WHERE trip_id = '".concat(tripId, "' AND status = 'Active'")).then(function (busData) {
        res.status(200).json(response.success({
          message: 'Trip cancelled successfully',
          busData: busData
        }));
      })["catch"](function (err) {
        res.status(500).json(response.error({
          message: 'Trip failed to cancel'
        }));
        logger.error({
          err: err,
          message: 'while canceling trip'
        });
      });
    }
  })["catch"](function (err) {
    logger.error(err);
    res.status(500).json(response.error('Failed to fetch trips'));
  });
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2FwcC9jb250cm9sbGVycy90cmlwcy5qcyJdLCJuYW1lcyI6WyJleHByZXNzIiwicmVxdWlyZSIsImxvZ2dlciIsImNyZWF0ZUxvZ2dlciIsInJvdXRlciIsIlJvdXRlciIsInJlc3BvbnNlIiwiZGIiLCJVdGlscyIsImF1dGhDaGVjayIsInBvc3QiLCJyZXEiLCJyZXMiLCJib2R5IiwiYnVzSWQiLCJvcmlnaW4iLCJkZXN0aW5hdGlvbiIsImZhcmUiLCJ0cmlwRGF0ZSIsImRlcGFydHVyZVRpbWUiLCJkYXRhIiwiZGVjb2RlZCIsImNvbnNvbGUiLCJsb2ciLCJpc19hZG1pbiIsInN0YXR1cyIsImpzb24iLCJlcnJvciIsInVuaXF1aSIsInJhbmRvbVN0cmluZyIsInF1ZXJ5IiwidGhlbiIsImJ1c0RhdGEiLCJyb3dDb3VudCIsIkJvb2xlYW4iLCJyb3dzIiwidHJpcF9zdGF0dXMiLCJ0ZXh0IiwidmFsdWVzIiwidXNlcklkIiwidHJpbVJpZ2h0IiwicmVzcCIsInN1Y2Nlc3MiLCJlcnIiLCJnZXQiLCJwYXRjaCIsInRyaXBJZCIsInBhcmFtcyIsIm1lc3NhZ2UiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLFNBQUQsQ0FBdkI7O0FBQ0EsSUFBTUMsTUFBTSxHQUFHRCxPQUFPLENBQUMsUUFBRCxDQUFQLENBQWtCRSxZQUFsQixDQUErQixtQkFBL0IsQ0FBZjs7QUFFQSxJQUFNQyxNQUFNLEdBQUdKLE9BQU8sQ0FBQ0ssTUFBUixFQUFmOztBQUNBLElBQU1DLFFBQVEsR0FBR0wsT0FBTyxDQUFDLHFCQUFELENBQXhCOztBQUNBLElBQU1NLEVBQUUsR0FBR04sT0FBTyxDQUFDLGNBQUQsQ0FBbEI7O0FBQ0EsSUFBTU8sS0FBSyxHQUFHUCxPQUFPLENBQUMsa0JBQUQsQ0FBckI7O0FBRUEsSUFBTVEsU0FBUyxHQUFHUixPQUFPLENBQUMsMkJBQUQsQ0FBekI7O0FBRUFHLE1B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QUQsRUFBUztBQUNoQnpDLElBQUFBLE1BQU0sQ0FBQ3lCLEtBQVAsQ0FBYWdCLEdBQWI7QUFFQS9CLElBQUFBLEdBQUcsQ0FBQ2EsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCcEIsUUFBUSxDQUFDcUIsS0FBVCxDQUFlLHVCQUFmLENBQXJCO0FBQ0QsR0FmRDtBQWdCRCxDQW5GRDtBQXFGQXNCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjlDLE1BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJ2xvZ2dlcicpLmNyZWF0ZUxvZ2dlcignLi9kZXZlbG9wbWVudC5sb2cnKTtcblxuY29uc3Qgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcbmNvbnN0IHJlc3BvbnNlID0gcmVxdWlyZSgnLi4vaGVscGVycy9yZXNwb25zZScpO1xuY29uc3QgZGIgPSByZXF1aXJlKCcuLi9jb25maWcvZGInKTtcbmNvbnN0IFV0aWxzID0gcmVxdWlyZSgnLi4vaGVscGVycy91dGlscycpO1xuXG5jb25zdCBhdXRoQ2hlY2sgPSByZXF1aXJlKCcuLi9taWRkbGV3YXJlcy9hdXRoX2NoZWNrJyk7XG5cbnJvdXRlci5wb3N0KCcvJywgYXV0aENoZWNrLCAocmVxLCByZXMpID0+IHtcbiAgLy8gbmV3IHRyaXBcbiAgY29uc3Qge1xuICAgIGJ1c0lkLFxuICAgIG9yaWdpbixcbiAgICBkZXN0aW5hdGlvbixcbiAgICBmYXJlLFxuICAgIHRyaXBEYXRlLFxuICAgIGRlcGFydHVyZVRpbWUsXG5cbiAgfSA9IHJlcS5ib2R5O1xuICBjb25zdCB7IGRhdGEgfSA9IHJlcS5kZWNvZGVkO1xuICBjb25zb2xlLmxvZyhkYXRhKTtcblxuICBpZiAoIWRhdGEuaXNfYWRtaW4pIHtcbiAgICByZXMuc3RhdHVzKDQwMSkuanNvbihyZXNwb25zZS5lcnJvcignQWNjZXNzIERlbmllZCcpKTtcbiAgfVxuXG4gIGNvbnN0IHVuaXF1aSA9IFV0aWxzLnJhbmRvbVN0cmluZygyMDApO1xuXG4gIGRiLnF1ZXJ5KGBTRUxFQ1QgKiBGUk9NIGJ1cyBXSEVSRSBidXNfaWQgPSAnJHtidXNJZH0nYCkudGhlbigoYnVzRGF0YSkgPT4ge1xuICAgIGlmIChidXNEYXRhLnJvd0NvdW50IDw9IDApIHtcbiAgICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHJlc3BvbnNlLmVycm9yKCdCdXMgbm90IGZvdW5kJykpO1xuICAgIH0gZWxzZSBpZiAoQm9vbGVhbihidXNEYXRhLnJvd3NbMF0udHJpcF9zdGF0dXMpID09PSB0cnVlKSB7XG4gICAgICByZXMuc3RhdHVzKDQwMykuanNvbihyZXNwb25zZS5lcnJvcignQnVzIGhhcyBhIHRyaXAgdGhhdCBpcyBhY3RpdmUnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHF1ZXJ5ID0ge1xuICAgICAgICB0ZXh0OiAnSU5TRVJUIElOVE8gdHJpcHModXNlcl9pZCxidXNfaWQsb3JpZ2luLGRlc3RpbmF0aW9uLHRyaXBfZGF0ZSxmYXJlLGRlcGFydHVyZV90aW1lLHRyaXBfaWQsc3RhdHVzKSBWQUxVRVMoJDEsJDIsJDMsJDQsJDUsJDYsJDcsJDgsJDkpIFJFVFVSTklORyAqJyxcbiAgICAgICAgdmFsdWVzOiBbZGF0YS51c2VySWQsIGJ1c0lkLCBvcmlnaW4sIGRlc3RpbmF0aW9uLCB0cmlwRGF0ZSwgZmFyZSwgZGVwYXJ0dXJlVGltZSwgdW5pcXVpLnRyaW1SaWdodCgpLCAnQWN0aXZlJ10sXG4gICAgICB9O1xuXG4gICAgICBkYi5xdWVyeShxdWVyeSkudGhlbigocmVzcCkgPT4ge1xuICAgICAgICBkYi5xdWVyeShgVVBEQVRFIGJ1cyBTRVQgdHJpcF9zdGF0dXMgPSAnJHt0cnVlfScgV0hFUkUgYnVzX2lkID0gJyR7YnVzSWR9JyBSRVRVUk5JTkcgKmApLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKHJlc3BvbnNlLnN1Y2Nlc3MocmVzcC5yb3dzWzBdKSk7XG4gICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyKTtcblxuICAgICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHJlc3BvbnNlLmVycm9yKCdTb21ldGhpbmcgd2VudCB3cm9uZycpKTtcbiAgICAgICAgfSk7XG4gICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihlcnIpO1xuXG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHJlc3BvbnNlLmVycm9yKCdTb21ldGhpbmcgd2VudCB3cm9uZycpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgIGxvZ2dlci5lcnJvcihlcnIpO1xuXG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24ocmVzcG9uc2UuZXJyb3IoJ1dob29wcyEgU29tZXRoaW5nIHdlbnQgd3JvbmcnKSk7XG4gIH0pO1xufSkuZ2V0KCcvJywgKHJlcSwgcmVzKSA9PiB7XG4gIC8vIGdldCBhbGwgdHJpcHMgYXZhaWxhYmxlXG4gIGRiLnF1ZXJ5KFwiU0VMRUNUICogRlJPTSB0cmlwcyBXSEVSRSBzdGF0dXMgPSAnQWN0aXZlJyBcIikudGhlbigocmVzcCkgPT4ge1xuICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHJlc3BvbnNlLnN1Y2Nlc3MocmVzcC5yb3dzKSk7XG4gIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICBsb2dnZXIuZXJyb3IoZXJyKTtcblxuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHJlc3BvbnNlLmVycm9yKCdGYWlsZWQgdG8gZmV0Y2ggdHJpcHMnKSk7XG4gIH0pO1xufSkucGF0Y2goJy86dHJpcElkJywgYXV0aENoZWNrLCAocmVxLCByZXMpID0+IHtcbiAgLy8gY2FuY2VsIGEgdHJpcFxuICBjb25zdCB0cmlwSWQgPSByZXEucGFyYW1zLnRyaXBJZDtcbiAgY29uc3QgeyBkYXRhIH0gPSByZXEuZGVjb2RlZDtcbiAgaWYgKCFkYXRhLmlzX2FkbWluKSB7XG4gICAgcmVzLnN0YXR1cyg0MDEpLmpzb24ocmVzcG9uc2UuZXJyb3IoJ0FjY2VzcyBEZW5pZWQnKSk7XG4gIH1cblxuICBkYi5xdWVyeShgU0VMRUNUICogRlJPTSB0cmlwcyBXSEVSRSBzdGF0dXMgPSAnQWN0aXZlJyBBTkQgdHJpcF9pZCA9ICcke3RyaXBJZH0nIGApLnRoZW4oKHJlc3ApID0+IHtcbiAgICBpZiAocmVzcC5yb3dDb3VudCA8PSAwKSB7XG4gICAgICByZXMuc3RhdHVzKDQwNCkuanNvbihyZXNwb25zZS5lcnJvcignVHJpcCBOb3QgZm91bmQnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRiLnF1ZXJ5KGBVUERBVEUgdHJpcHMgU0VUIHN0YXR1cyA9ICdjYW5jZWxsZWQnIFdIRVJFIHRyaXBfaWQgPSAnJHt0cmlwSWR9JyBBTkQgc3RhdHVzID0gJ0FjdGl2ZSdgKS50aGVuKChidXNEYXRhKSA9PiB7XG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHJlc3BvbnNlLnN1Y2Nlc3MoeyBtZXNzYWdlOiAnVHJpcCBjYW5jZWxsZWQgc3VjY2Vzc2Z1bGx5JywgYnVzRGF0YSB9KSk7XG4gICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHJlc3BvbnNlLmVycm9yKHsgbWVzc2FnZTogJ1RyaXAgZmFpbGVkIHRvIGNhbmNlbCcgfSkpO1xuICAgICAgICBsb2dnZXIuZXJyb3IoeyBlcnIsIG1lc3NhZ2U6ICd3aGlsZSBjYW5jZWxpbmcgdHJpcCcgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICBsb2dnZXIuZXJyb3IoZXJyKTtcblxuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHJlc3BvbnNlLmVycm9yKCdGYWlsZWQgdG8gZmV0Y2ggdHJpcHMnKSk7XG4gIH0pO1xufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gcm91dGVyO1xuIl19