{"version":3,"sources":["../../app/controllers/bookings.js"],"names":["express","require","router","Router","check","validationResult","body","sanitizeBody","response","db","Utils","authCheck","post","req","res","tripId","params","data","decoded","user","userId","busIsFilled","bus","booked","state","query","then","busData","busExists","rowCount","capacity","rows","Number","err","console","log","incrementNumberBooked","tripid","userHasPreviousBooking","trip","userBooking","resp","status","json","error","busId","bus_id","bookings","isFilled","filledRes","isBooked","bookedRes","randomString","trip_id","Date","respo","success","patch","admin","is_admin","bookingId","deletedRow","get","filter","user_id","module","exports"],"mappings":"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","sourcesContent":["const express = require('express');\n\nconst router = express.Router();\nconst {\n  check,\n  validationResult, body\n} = require('express-validator');\n\nconst { sanitizeBody } = require('express-validator');\nconst response = require('../helpers/response');\nconst db = require('../config/db');\nconst Utils = require('../helpers/utils');\n\nconst authCheck = require('../middlewares/auth_check');\n\n// Book a seat on a trip\nrouter.post('/:tripId', authCheck, (req, res) => {\n  const tripId = req.params.tripId;\n  const { data } = req.decoded;\n  const user = data.userId;\n\n  const busIsFilled = (bus, booked) => {\n    let state = null;\n    return db.query(`SELECT capacity from bus WHERE bus_id ='${bus}'`).then((busData) => {\n      const busExists = busData.rowCount > 0;\n      if (busExists) {\n        const capacity = busData.rows[0].capacity;\n        if (Number(booked) > Number(capacity)) {\n          state = true;\n        } else {\n          state = false;\n        }\n      } else {\n        state = false;\n      }\n      return state;\n    }).catch((err) => {\n      state = false;\n      console.log(err);\n    });\n  };\n\n  const incrementNumberBooked = (tripid) => {\n    db.query(`UPDATE trips SET bookings = bookings + 1 WHERE trip_id = '${tripid}'`).then((res) => {\n      console.log('Updated');\n    }).catch((err) => {\n      console.log(err);\n    });\n  };\n\n  const userHasPreviousBooking = (trip) => {\n    return db.query(`SELECT * FROM bookings WHERE user_id = '${user}' AND status = 'Active' AND trip_id = '${trip}'`).then((userBooking) => {\n      console.log(userBooking);\n      if (userBooking.rowCount > 0) {\n        return true;\n      }\n      return false;\n    }).catch((err) => {\n      console.log(err);\n      return false;\n    });\n  };\n  // check the bus capacity\n  // check if bus is filled with respect to trip booking, add new column for this number_booked\n  // for each new trip booking increment the number_booked\n  db.query(`SELECT * FROM trips WHERE trip_id = '${tripId}' AND status = 'Active'`)\n    .then((resp) => {\n      if (resp.rowCount <= 0) {\n        res.status(404).json(response.error('Trip not found'));\n      }\n      const busId = resp.rows[0].bus_id;\n      const bookings = resp.rows[0].bookings;\n      const isFilled = busIsFilled(busId, bookings);\n      isFilled.then((filledRes) => {\n        if (filledRes) {\n          res.status(200).json(response.error('Bus is full'));\n        } else {\n          // check if user has booked before and return bookin details\n          const isBooked = userHasPreviousBooking(tripId);\n          isBooked.then((bookedRes) => {\n            if (bookedRes) {\n              res.status(403).json(response.error('Already booked by user'));\n            }\n          });\n\n          db.query('INSERT INTO bookings(booking_id,trip_id,user_id,created_on,status,seat_number) VALUES($1,$2,$3,$4,$5) RETURNING *',\n            [Utils.randomString(200), resp.rows[0].trip_id, user, new Date(), 'Active', bookings + 1]).then((respo) => {\n            incrementNumberBooked(tripId);\n            res.status(201).json(response.success(respo.rows[0]));\n          }).catch((err) => {\n            res.status(500).json(response.error('Failed to book trip'));\n            console.log(err);\n          });\n        }\n      }).catch((err) => {\n        console.log(err);\n      });\n    }).catch((err) => {\n      res.status(500).json(response.error('Whoops! Something went wrong'));\n      console.log(err);\n    });\n});\n\nrouter.patch('/:bookingId', authCheck, (req, res) => {\n// delete bookking\n  const { data } = req.decoded;\n\n  const admin = data.is_admin;\n  const user = data.userId;\n\n  const bookingId = req.params.bookingId;\n\n  db.query(`SELECT * FROM bookings WHERE bookingId = '${bookingId}' AND status =  'Active' `)\n    .then((resp) => {\n      if (resp.rowCount < 0) {\n        res.status(404).json(response.error('Booking ID not found'));\n      }\n      if (admin) {\n        db.query(`UPDATE bookings SET status = 'deleted' WHERE bookingId = '${bookingId}' RETURNING *`)\n          .then((deletedRow) => {\n            console.log(deletedRow);\n            res.status(200).json(response.success(deletedRow.rows[0]));\n          }).catch((err) => {\n            console.log(err);\n\n            res.status(500).json(response.error('Failed to cancle booking,check server logs'));\n          });\n      } else {\n        db.query(`UPDATE bookings SET status = 'deleted' WHERE booking_id = '${bookingId}' AND user_id = '${user}' RETURNING *`)\n          .then((deletedRow) => {\n            console.log(deletedRow);\n            res.status(200).json(response.success(deletedRow.rows[0]));\n          }).catch((err) => {\n            console.log(err);\n\n            res.status(500).json(response.error('Failed to cancle booking,check server logs'));\n          });\n      }\n    }).catch((err) => {\n      res.status(500).json(response.error('Whoops! Something went wrong'));\n      console.log(err);\n    });\n});\n\nrouter.get('/', authCheck, (req, res) => {\n// get all bookings\n  const { data } = req.decoded;\n  const user = data.userId;\n  const admin = data.is_admin;\n  console.log(user);\n\n  db.query('SELECT bookings.user_id,users.email,users.first_name,users.last_name,bookings.booking_id FROM bookings INNER JOIN users USING (user_id)')\n    .then((resp) => {\n      if (admin) {\n        res.status(200).json(response.success(resp.rows));\n      } else {\n        const userBooking = resp.rows.filter((bookings) => {\n          console.log(bookings);\n          return bookings.user_id === user;\n        });\n        console.log(userBooking);\n        res.status(200).json(response.success({ userBooking, for: 'user' }));\n      }\n    }).catch((err) => {\n      console.log(err);\n      res.status(500).json(response.error('Whoops! Failed to fetch booking'));\n    });\n});\n\nmodule.exports = router;\n"],"file":"bookings.js"}